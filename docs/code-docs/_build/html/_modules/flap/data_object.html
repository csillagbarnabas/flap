
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>flap.data_object &#8212; FLAP  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for flap.data_object</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Jan 22 17:37:32 2019</span>

<span class="sd">@author: Zoletnik</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="c1">#import time</span>
<span class="c1">#from .tools import *</span>
<span class="c1">#from .coordinate import *</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="kn">import</span> <span class="nn">flap.tools</span>
<span class="kn">import</span> <span class="nn">flap.coordinate</span>
<span class="kn">import</span> <span class="nn">flap.config</span>
<span class="kn">from</span> <span class="nn">.spectral_analysis</span> <span class="kn">import</span> <span class="n">_apsd</span><span class="p">,</span> <span class="n">_cpsd</span><span class="p">,</span> <span class="n">_trend_removal</span><span class="p">,</span> <span class="n">_ccf</span>
<span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">_plot</span>

<span class="n">PICKLE_PROTOCOL</span> <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="DataObject"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject">[docs]</a><span class="k">class</span> <span class="nc">DataObject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; This is the data object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        data_array: A numpy array with the data</span>
<span class="sd">        error: One or two numpy arrays with the error.</span>
<span class="sd">               An array: Symmetric error</span>
<span class="sd">               List of two arrays: asymmetric error ([low deviation,high deviation])</span>
<span class="sd">        data_unit: The unit of the data. Should be a UnitClass variable or None</span>
<span class="sd">        exp_id: Experiment ID. Can be None if not applicable.</span>
<span class="sd">        coordinates: flap.Coordinate class or list of flap.Coordinate class variables</span>
<span class="sd">                     compatible with the data array.</span>
<span class="sd">        data_title: Description of the data.</span>
<span class="sd">        data_shape: Used only if data_array is not present</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="n">exp_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_title</span> <span class="o">=</span> <span class="n">data_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">data_shape</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data_unit</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Unit</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data_unit for DataObject must be a flap.Unit.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_unit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="n">exp_id</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data for DataObject must be a numpy array.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error must be a numpy array or a list of two numpy arrays.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape of error array is different from that of data_array. &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error must be a numpy array or a list of two numpy arrays.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__coordinates</span>

    <span class="nd">@coordinates</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coordinates</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__coordinates</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">):</span>
                       <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad type in coordinates list.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__coordinates</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad type for coordinates.&quot;</span><span class="p">)</span>
                
<div class="viewcode-block" id="DataObject.check"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Does a consistency check for the data object and raises errors if problems found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong data array. DataObject.data should be numpy.ndarray.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataObject.data shape is not the same as DataObject.shape.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataObject.shape is none. Even if no data is present shape should be set otherwise coordinates cannot be determined.&quot;</span><span class="p">)</span>                
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong number of elements in error. If DataObject.error is a list it should have two elements.&quot;</span> <span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">err</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong error array in DataObject. It should be numpy.ndarray.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape of error  array un DataObject is different from data.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ID of coordinates &#39;</span><span class="si">{:s}</span><span class="s2">&#39; and &#39;</span><span class="si">{:s}</span><span class="s2">&#39; are identical.&quot;</span><span class="o">.</span>\
                                         <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ID of coordinate.mode for &#39;</span><span class="si">{:s}</span><span class="s2">&#39; and &#39;</span><span class="si">{:s}</span><span class="s2">&#39; are identical.&quot;</span><span class="o">.</span>\
                                         <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong type for dimension list for coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Too long dimension list for coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> 
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Null in dimension list in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>    
                    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong dimension number in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>                         
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">flap</span><span class="o">.</span><span class="n">Unit</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong coordinate unit in coordinate #</span><span class="si">{:d}</span><span class="s2">. Should be flap.Unit().&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">CoordinateMode</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong coordinate mode type in &#39;</span><span class="si">{:s}</span><span class="s2">&#39;. Should be flap.CoordinateMode().&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;No start for equdistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start</span> <span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid start value type for equdistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of step values is different from length of dimension_list in &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">cstep</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cstep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;One step is None for equdistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">cstep</span> <span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid step type for equdistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cstep</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">start</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Equidistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39; start and step should have same type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for value_ranges in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for value_ranges in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>  
                            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">start</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incompatible value_range and start in coordinate </span><span class="si">{:s}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incompatible value_range and start in coordinate </span><span class="si">{:s}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for value_ranges in asymmetric coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid list length for value_ranges in asymmetric coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">c_value_ranges</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">c_value_ranges</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for value_ranges in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for value_ranges in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>     
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No values in non-equidistant coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">non_interpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate value and data shape is inconsistent in coordinate &#39;</span><span class="si">{:s}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>
                                                                    
<div class="viewcode-block" id="DataObject.coordinate_names"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate_names">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list with the coordinate names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">del_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; not found in data object.&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">==</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DataObject.get_coordinate_object"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.get_coordinate_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_coordinate_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the Coordinate class having the given name. The returned object is a link not a copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataObject.add_coordinate_object"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.add_coordinate_object">[docs]</a>    <span class="k">def</span> <span class="nf">add_coordinate_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coordinate</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a flap.Coordinate instance to the list of coordinates</span>
<span class="sd">            If index is not set adds to the end of the list. Otherwise adds to the position</span>
<span class="sd">            shown by index. (0 is beginning of list.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">coordinate</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">coordinate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataObject.add_coordinate"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.add_coordinate">[docs]</a>    <span class="k">def</span> <span class="nf">add_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is a general coordinate conversion interface.</span>
<span class="sd">            Adds the requested coordinate(s) to the data_object.</span>
<span class="sd">        INPUT:</span>
<span class="sd">            coordinates: List of coordinates to add. (string array)</span>
<span class="sd">            data_source: Optional data_source. Use this not the one in data_object</span>
<span class="sd">            exp_id: Optional exp_id. Use this not the one in data_object</span>
<span class="sd">            options: Dictionary of options.</span>
<span class="sd">        Returns the modified data object. Note that the input data object remanins the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_data_source</span> <span class="o">=</span> <span class="n">data_source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_coordinates</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">_coordinates</span><span class="p">]</span>
        <span class="c1"># Checking whether the coordinates are already present</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">_coordinates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">_data_source</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="c1"># Finding the add_coordinate function for this data source</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">get_addcoord_function</span><span class="p">(</span><span class="n">_data_source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No add_coordinate function is associated with data source &quot;</span>
                             <span class="o">+</span> <span class="n">_data_source</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coordinates</span><span class="o">=</span><span class="n">_coordinates</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="DataObject.coordinate_change_indices"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate_change_indices">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate_change_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the indices to the data array for which the coordinate changes.</span>
<span class="sd">            The returned value is a tuple of indices, the number of elements equals the</span>
<span class="sd">            dimension of the data. This can be directly used to get the coordinate values</span>
<span class="sd">            using coordinate()</span>
<span class="sd">        name: Coordinate name (string)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
            <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span></div>

<div class="viewcode-block" id="DataObject.to_intervals"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.to_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">to_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coordinate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create an Intervals class object from either the data error ranges or</span>
<span class="sd">            the coordinate value ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">coordinate</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use a flap.DataObject as intervals either the data_unit.name or a coordinate name should be identical to the coordinate.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use a coordinate as interval it must have ranges set.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use a coordinate as interval it must change along maximum one dimension.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">,</span>
                                                          <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">,</span>
                                                          <span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">,</span>
                                                          <span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
                                                          <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">,</span>
                                                          <span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
                                                          <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">index</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="o">...</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">,</span> <span class="n">d_low</span><span class="p">,</span> <span class="n">d_high</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">d_low</span><span class="p">,</span> <span class="n">d_high</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use a data object as interval it must have data and error.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                                      <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                                      <span class="p">)</span>
        <span class="k">return</span> <span class="n">intervals</span></div>

<div class="viewcode-block" id="DataObject.slicing_to_intervals"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.slicing_to_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">slicing_to_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slicing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert a multi-slicing description to an Intervals object.</span>
<span class="sd">            For possibilities see DataObject.slice_data().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;slicing_to_intervals(): slicing should be a dictionary.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;slicing_to_intervals(): slicing dictionary should have only one element.&quot;</span><span class="p">)</span>

        <span class="n">slicing_coord_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slicing_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord_name</span><span class="p">)</span>
        <span class="n">slicing_description</span> <span class="o">=</span> <span class="n">slicing</span><span class="p">[</span><span class="n">slicing_coord_name</span><span class="p">]</span>

        <span class="c1"># Getting the range of the slicing coordinate</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">r_ext</span> <span class="o">=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">err1</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">err2</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err1</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">err2</span> <span class="o">=</span> <span class="n">err1</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">err1</span><span class="p">,</span> <span class="n">data</span><span class="o">+</span><span class="n">err2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
              <span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot do multi-slice with string type coordinate.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot do multi-slice with coordinate changing along multiple dimensions.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">start</span><span class="p">,</span>
                                                      <span class="n">stop</span><span class="p">,</span>
                                                      <span class="n">step</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">number</span><span class="o">=</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">,</span> <span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="o">==</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="n">slicing_description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid slicing description.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intervals</span></div>

<div class="viewcode-block" id="DataObject.proc_interval_limits"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.proc_interval_limits">[docs]</a>    <span class="k">def</span> <span class="nf">proc_interval_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine processing interval limits, both in coordinates and data indices.</span>
<span class="sd">            This is a helper routine for all functions which do some calculation as a function</span>
<span class="sd">            of one coordinate and allow processing only a set of intervals instead of the whole dataset.</span>
<span class="sd">            INPUT:</span>
<span class="sd">                coordinate: Name of the coordinate along which calculation will be done. This must</span>
<span class="sd">                            change only along a single data dimension.</span>
<span class="sd">                intervals: Information of processing intervals.</span>
<span class="sd">                           If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                               Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                               Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                               a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                               the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                               interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                               same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                               will be used fromm it to set the intervals.</span>
<span class="sd">                           If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                               description, the selection coordinate is taken the same as</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                           If None, the whole data interval will be used as a single interval.</span>
<span class="sd">            Return value:</span>
<span class="sd">                calc_int, calc_int_ind, sel_int, sel_int_ind</span>
<span class="sd">                Each return value is a list of numpy arrays: [start, end]</span>
<span class="sd">                The calc_xxx values are for the calculation coordinate, the sel_xxx are for the</span>
<span class="sd">                selection coordinate. xxx_int is in coordinate values, xxx_int_ind is in data index</span>
<span class="sd">                values which follows the Python convention, end index is not included.</span>
<span class="sd">                The index start indices will be always smaller than the end indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Getting the coordinate object for the processing coordinate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Processing coordinate may change only along one dimension.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_intervals</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">sel_coordinate</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
            <span class="n">_intervals</span> <span class="o">=</span> <span class="n">intervals</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sel_coordinate</span> <span class="o">==</span> <span class="n">coordinate</span><span class="p">):</span>
            <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="n">coord_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">sel_coordinate</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Selection coordinate may change only along one dimension.&quot;</span><span class="p">)</span>

        <span class="c1">#Converting all input interval descriptions to Interval object</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">input_intervals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">_intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">input_intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
            <span class="n">input_intervals</span> <span class="o">=</span> <span class="n">_intervals</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_intervals</span> <span class="o">=</span> <span class="n">_intervals</span><span class="o">.</span><span class="n">to_intervals</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid interval description.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Determining selection coordinate index ranges</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">input_intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sel_int_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> 
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
                        <span class="c1"># Converting from index to coordinate</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">ind_first</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">ind_first</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind_last</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">ind_last</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">sel_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_first</span><span class="p">)]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_last</span><span class="p">)]])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Limiting the range to the coordinte values</span>
            <span class="n">limits</span><span class="p">,</span> <span class="n">limits_range</span> <span class="o">=</span> <span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># Determining interval start and end values</span>
            <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">input_intervals</span><span class="o">.</span><span class="n">interval_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span><span class="n">partial_intervals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sel_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">]</span>
            <span class="c1"># Converting to indices</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">))</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_from_coordinate</span><span class="p">(</span><span class="n">sel_coordinate</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">sel_int_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">ind</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:]]</span>
                
        <span class="c1"># Determining interval limits for the calculating coordinate</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sel_coordinate</span> <span class="o">==</span> <span class="n">coordinate</span><span class="p">):</span>
            <span class="n">calc_int</span> <span class="o">=</span> <span class="n">sel_int</span>
            <span class="n">calc_int_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimmension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># If the calculating corodinate changes along the same dimension as the selection</span>
                <span class="c1"># then the same index ranges are used</span>
                <span class="n">calc_int_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise the whole calculation index range is used</span>
                <span class="n">calc_int_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
            <span class="c1"># Converting from index to coordinate</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">calc_int_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">calc_int_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#there was calc_obj.dimension_list[0] here instead of coord_obj</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">calc_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:]]</span>
        
        <span class="k">return</span> <span class="n">calc_int</span><span class="p">,</span> <span class="n">calc_int_ind</span><span class="p">,</span> <span class="n">sel_int</span><span class="p">,</span> <span class="n">sel_int_ind</span></div>
        
<div class="viewcode-block" id="DataObject.coordinate"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the coordinates of a subarray of the data array.</span>
<span class="sd">        name: Coordinate name (string)</span>
<span class="sd">        index: The indexes into the data array (tuple with various elements, see Coordinate.data())</span>
<span class="sd">        options: The same options as for Coordinate.data()</span>

<span class="sd">        returns 3 np.arrays:</span>
<span class="sd">            data: the coordinates. The number of dimension is the same as the dimension of</span>
<span class="sd">                  the data array, but the number  of elements are taken from index.</span>
<span class="sd">            data_low: low ranges, same shape as data. None if no range data is present</span>
<span class="sd">            data_high: high ranges, same shape as data. None if no range data is present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid coordinate name.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="p">,</span><span class="n">d_low</span><span class="p">,</span><span class="n">d_high</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">,</span><span class="n">d_low</span><span class="p">,</span><span class="n">d_high</span></div>
    
<div class="viewcode-block" id="DataObject.coordinate_range"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate_range">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=...</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the ranges of a coordinate.</span>
<span class="sd">        name: Coordinate name (string)</span>

<span class="sd">        Returns the data range and the data range with errors for the coordinate. Both are lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dr</span><span class="p">,</span> <span class="n">dr_e</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dr_e</span></div>


<div class="viewcode-block" id="DataObject.index_from_coordinate"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.index_from_coordinate">[docs]</a>    <span class="k">def</span> <span class="nf">index_from_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">coord_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the closest data indices of the coordinate values.</span>
<span class="sd">            Coordinates should change only along one dimension.</span>
<span class="sd">            It is assumed that coordinates change monotonically.</span>
<span class="sd">        INPUT:</span>
<span class="sd">            name: Coordinate name (string)</span>
<span class="sd">            coord_values: The coordinate values to convert to indices.</span>
<span class="sd">                          (numpy array or list is scalar)</span>
<span class="sd">        Return value:</span>
<span class="sd">            Returns the indices in the same format as the input coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To convert to indices coordinate should change along one dimension.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_coord_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)):</span>
            <span class="n">_coord_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coord_values</span><span class="p">])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">_coord_values</span> <span class="o">=</span> <span class="n">coord_values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid type for coord_values.&quot;</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">coordinate_data</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">coordinate_data</span> <span class="o">=</span> <span class="n">coordinate_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">data_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">sort_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">coordinate_data</span><span class="p">)</span>
        <span class="n">coordinate_data_sorted</span> <span class="o">=</span> <span class="n">coordinate_data</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>
        <span class="n">data_index_sorted</span> <span class="o">=</span> <span class="n">data_index</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>
        <span class="n">_index_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">_coord_values</span><span class="p">,</span>
                                           <span class="n">coordinate_data_sorted</span><span class="p">,</span>
                                           <span class="n">data_index_sorted</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">index_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_index_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)):</span>
            <span class="n">index_values</span> <span class="o">=</span> <span class="n">_index_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coord_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">index_values</span> <span class="o">=</span> <span class="n">_index_values</span>

        <span class="k">return</span> <span class="n">index_values</span></div>

<div class="viewcode-block" id="DataObject.coordinate_change_dimensions"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate_change_dimensions">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate_change_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of dimensions of the data array along which</span>
<span class="sd">        the named coordinate changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">change_dimensions</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataObject.coordinate_nochange_dimensions"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.coordinate_nochange_dimensions">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate_nochange_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of dimensions of the data array along which</span>
<span class="sd">        the named coordinate changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not present in data object.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">change_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_plot_error_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper function to return error low and high limits as needed by matplotlib</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">_index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">_index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_plot_coord_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coord</span><span class="p">,</span> <span class="n">c_data</span><span class="p">,</span> <span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper function to return error low and high limits from coordiniate data</span>
<span class="sd">            in the format needed by matplotlib</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">c_low</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">c_low</span><span class="o">.</span><span class="n">size</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">c_low</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">c_low</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">c_high</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">err</span>

<div class="viewcode-block" id="DataObject.plot"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">slicing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">slicing_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">summing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a data object.</span>
<span class="sd">        axes: A list of coordinate names (strings). They should be one of the coordinate</span>
<span class="sd">              names in the data object or &#39;Data&#39;</span>
<span class="sd">              They describes the axes of the plot.</span>
<span class="sd">              If the number of axes is less than the number required for the plot, &#39;Data&#39; will be added.</span>
<span class="sd">              If no axes are given default will be used depending on the plot type. E.g. for</span>
<span class="sd">              x-y plot the default first axis is the firs coordinate, the second axis is &#39;Data&#39;</span>
<span class="sd">        plot_type: The plot type (string)</span>
<span class="sd">              &#39;xy&#39;: Simple 1D plot. Default axes are: first coordinate, Data</span>
<span class="sd">              &#39;multi xy&#39;: In case of 2D data plots 1D curves with vertical shift</span>
<span class="sd">                          Default x axis is first coordinate, y axis is Data</span>
<span class="sd">                          The signals are named in the label with the &#39;Signal name&#39; coordinate or the one</span>
<span class="sd">                          named in options[&#39;Signal name&#39;]</span>
<span class="sd">        plot_options: Dictionary. Will be passed over to the plot call.</span>
<span class="sd">        slicing, summing: arguments for slice_data. Slicing will be applied before plotting.</span>
<span class="sd">        options:</span>
<span class="sd">            Matplotlib options like xtitle, xlimit, etc</span>
<span class="sd">            Plot options:</span>
<span class="sd">                &#39;All points&#39; True or False</span>
<span class="sd">                             default is False. If True will plot all points otherwise will use</span>
<span class="sd">                             the sample_to_plot function</span>
<span class="sd">                &#39;Error&#39;      True: Plot all error bars (default: True)</span>
<span class="sd">                             False: Do not plot errors</span>
<span class="sd">                             number &gt; 0: Plot this many error bars in plot</span>
<span class="sd">                &#39;Y separation&#39; Vertical separation of curves in multi xy plot. For linear scale this will</span>
<span class="sd">                               be added to consecutive cureves. For Log scale consecutive curves will be</span>
<span class="sd">                               multiplied by this.</span>
<span class="sd">                &#39;Log x&#39; : Logscale X axis</span>
<span class="sd">                &#39;Log y&#39; : Logscale Y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                         <span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">,</span>
                         <span class="n">slicing_options</span><span class="o">=</span><span class="n">slicing_options</span><span class="p">,</span>
                         <span class="n">summing</span><span class="o">=</span><span class="n">summing</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                         <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
                         <span class="n">plot_options</span><span class="o">=</span><span class="n">plot_options</span><span class="p">,</span>
                         <span class="n">plot_id</span><span class="o">=</span><span class="n">plot_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">e</span></div>
            
            
    <span class="k">def</span> <span class="nf">__moveaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is an internal function to move an axis in the data and error arrays.</span>
<span class="sd">            Does not do anything to the coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">destination</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">source</span><span class="p">,</span><span class="n">destination</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">destination</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_object</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is an internal function to create empty data and error arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">source_object</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_object</span><span class="p">,</span> <span class="n">destination_ind</span><span class="p">,</span> <span class="n">source_ind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is an internal function to copy data from one data object to the other with</span>
<span class="sd">            possibly different shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">destination_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_object</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">source_ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">destination_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">source_ind</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">destination_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_object</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">source_ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__fill_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is an internal function to fill certain elements in the data and error with NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__check_coords_after_simple_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sliced_dimensions</span><span class="p">,</span> <span class="n">sliced_removed</span><span class="p">,</span> <span class="n">ind_slice_coord</span><span class="p">,</span> <span class="n">original_shape</span><span class="p">,</span> 
                                          <span class="n">dimension_mapping</span><span class="p">,</span> <span class="n">slicing_equidistant</span><span class="p">,</span><span class="n">slicing_coord</span><span class="p">,</span><span class="n">_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is an internal function to modify the coordinates after a simple (non-interval) slice operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">check_coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="c1"># Do nothing for scalar dimension</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Determine common dimension list of this coordinate with the sliced one</span>
            <span class="n">common_dims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sliced_dimensions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">common_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># If there are common dimensions then must change the description</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Checking if this coordinate can be equidistant. Two cases qualify:</span>
                <span class="c1"># 1. If this is the slicing coordinate and the slicing is equidistant</span>
                <span class="c1"># 2. If this is not the slicing coordinate but both this and the slicing coordinates are equidistant</span>
                <span class="c1">#    along a single dimension</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">slicing_equidistant</span> <span class="ow">and</span>
                    <span class="p">((</span><span class="n">check_coord</span> <span class="o">==</span> <span class="n">slicing_coord</span><span class="p">)</span> 
                     <span class="ow">or</span> <span class="p">((</span><span class="n">check_coord</span> <span class="o">!=</span> <span class="n">slicing_coord</span><span class="p">)</span>  
                         <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="ow">and</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">)</span>
                         <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="ow">and</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span>
                        <span class="p">)</span>
                     <span class="p">)</span>
                    <span class="p">):</span>
                    <span class="c1"># if this coordinate is equidistant and changes along one dimension </span>
                    <span class="c1"># and slicing is also equidistant</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span>    \
                                            <span class="o">+</span> <span class="n">ind_slice_coord</span><span class="o">.</span><span class="n">start</span>   \
                                               <span class="o">*</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ind_slice_coord</span><span class="o">.</span><span class="n">step</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span>    \
                                            <span class="o">+</span> <span class="n">ind_slice_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   \
                                               <span class="o">*</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">-</span> <span class="n">ind_slice_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                                                                 <span class="o">/</span> <span class="p">(</span><span class="n">ind_slice_coord</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                      
                    <span class="k">if</span> <span class="p">(</span><span class="n">sliced_removed</span><span class="p">):</span>
                       <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                       <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span>
                    <span class="n">check_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This coordinate will be non-equidistant</span>
                    <span class="c1"># Determining dimension list containing dimensions from this coordinate</span>
                    <span class="c1"># and the sliced ones</span>
                    <span class="n">unified_dims</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unify_list</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">,</span> <span class="n">sliced_dimensions</span><span class="p">)</span>
                    <span class="c1"># Getting coordinate data for this unified array</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unified_dims</span><span class="p">:</span>
                        <span class="n">index</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                    <span class="n">original_coord_data</span><span class="p">,</span> <span class="n">data_low</span><span class="p">,</span> <span class="n">data_high</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">original_shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                    <span class="c1"># The shape of the unified dimension space</span>
                    <span class="n">unified_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">original_shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unified_dims</span><span class="p">]</span>
                    <span class="c1"># Reshaping to this unified shape, other dimensions have 1 element which will be removed</span>
                    <span class="n">new_coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_coord_data</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">unified_shape</span><span class="p">))</span>
                    <span class="c1"># Determining indices in unified dimension list which are flattened</span>
                    <span class="n">flattened_in_unified</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i_d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unified_dims</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sliced_dimensions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">unified_dims</span><span class="p">[</span><span class="n">i_d</span><span class="p">])</span>
                            <span class="n">flattened_in_unified</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_d</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># Flattening these dimensions in the coordinate data matrix</span>
                    <span class="n">new_coord_data</span><span class="p">,</span> <span class="n">flat_dim_mapping</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">new_coord_data</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">)</span>
                    <span class="c1"># Doing the same with coordinate ranges</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">unified_shape</span><span class="p">))</span>
                        <span class="n">data_low</span><span class="p">,</span> <span class="n">xxx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                           <span class="n">data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_high</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">unified_shape</span><span class="p">))</span>
                           <span class="n">data_high</span><span class="p">,</span> <span class="n">xxx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">data_high</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">)</span>
                    <span class="c1"># Creating a list of slices for all dimension, so as all elements are copied</span>
                    <span class="n">ind_slice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                        <span class="c1"># In the flattened dimensions inserting the slicing index array or slice</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="n">ind_slice</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ind_slice</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="c1"># Selecting the coordinate data for the remaining data elements</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)]))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                <span class="n">data_high</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)]</span>                        
                                <span class="k">if</span> <span class="p">(</span><span class="n">data_high</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">data_high</span> <span class="o">=</span> <span class="n">data_high</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Linear&#39;</span><span class="p">):</span>
                        <span class="c1"># ind_slice_coord is numpy array</span>
                        <span class="n">ind_slice_coord_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">ind_slice_coord_2</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_slice_coord_2</span> <span class="o">&gt;=</span> <span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">ind_slice_coord_2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> 
                        <span class="c1"># Insert the lower slicing indices into the flattened dimension and get the two base points</span>
                        <span class="c1"># for interpolation</span>
                        <span class="n">ind_slice_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)</span>
                        <span class="n">ind_slice_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)</span>
                        <span class="n">ind_slice_1</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span>
                        <span class="n">d1</span> <span class="o">=</span> <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                        <span class="n">ind_slice_2</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord_2</span>
                        <span class="n">d2</span> <span class="o">=</span> <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                        <span class="c1"># Reshaping ind_slice_coord_1 and ind_slice_coord to an array with 1 elements in all</span>
                        <span class="c1"># dimensions except the coordinate dimension. This will broadcast with d2 and d2.</span>
                        <span class="n">interplol_weight_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">interplol_weight_shape</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">ind_slice_interp_1</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">interplol_weight_shape</span><span class="p">))</span>  
                        <span class="n">ind_slice_interp</span> <span class="o">=</span> <span class="n">ind_slice_coord</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">interplol_weight_shape</span><span class="p">))</span>                                        
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">d1</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                            <span class="n">d2</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                            <span class="n">data_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                <span class="n">d1</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                                <span class="n">d2</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                                <span class="n">data_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: cannot handle interpolation method &#39;</span><span class="si">{:s}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                           <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">data_low</span><span class="p">,</span>
                                                       <span class="n">data_high</span> <span class="o">-</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">data_low</span>
                    <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">check_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>

                <span class="c1">#  Updating the dimension list for the case when there are common</span>
                <span class="c1"># dimensions with the slicing coord</span>
                <span class="n">new_dimension_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># If in old dimension list</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="c1"># If it was not flattened</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">new_dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># If this is the first flattened dimension</span>
                    <span class="c1"># and it was not removed</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">==</span> <span class="n">sliced_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   \
                             <span class="ow">and</span> <span class="ow">not</span> <span class="n">sliced_removed</span><span class="p">):</span>
                        <span class="n">new_dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There are no common dimensions</span>
                <span class="n">new_dimension_list</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">new_dimension_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping. None dimension.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))):</span>
                <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="n">new_dimension_list</span>
            
    <span class="k">def</span> <span class="nf">__check_coords_after_multi_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slicing</span><span class="p">,</span>
                                         <span class="n">original_shape</span><span class="p">,</span>
                                         <span class="n">joint_slices</span><span class="p">,</span>
                                         <span class="n">joint_dimension_list</span><span class="p">,</span>
                                         <span class="n">dimension_mapping</span><span class="p">,</span>
                                         <span class="n">slice_description</span><span class="p">,</span>
                                         <span class="n">interval_dimension</span><span class="p">,</span>
                                         <span class="n">in_interval_dimension</span><span class="p">,</span>
                                         <span class="n">n_int</span><span class="p">,</span>
                                         <span class="n">n_in_int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal function to modify all coordinate descriptions after a mult-slice process. This or</span>
<span class="sd">            __check_coordds_after_simple_slice is called after each slice operation with a coordinate.</span>
<span class="sd">            In the slicing process before this call the dimensions in joint_dimension_list were flattened and the data distributed</span>
<span class="sd">            to the interval_dimension and in_interval_dimension.</span>
<span class="sd">            self is a copy of the original data object before slice with the data already sliced as</span>
<span class="sd">            described above.</span>
<span class="sd">            slicing: The slincing input of self.slice_data()</span>
<span class="sd">            original_shape: The original data shape before this slicing operation</span>
<span class="sd">            joint slices: The index of the keys in slicing.keys() which were done jointly</span>
<span class="sd">            joint_dimension_list: List of data dimension which were flattened</span>
<span class="sd">            dimension_mapping: mapping from original to new dimension numbers</span>
<span class="sd">            slice_description: Describing the indices in the data array for the intervals.</span>
<span class="sd">                                There are 3 options:</span>
<span class="sd">                                  slice: (for 1-coordinate slice only)</span>
<span class="sd">                                  dictionary with &#39;Starts&#39;, &#39;Stops&#39; keys: giving the interval</span>
<span class="sd">                                     start and stop indices with numpy arrays.</span>
<span class="sd">                                     Number of dimensions refer to the number of joint slice coordinates.</span>
<span class="sd">                                  list of numpy arrays: indices. If multiple coordinate multi-slice then</span>
<span class="sd">                                    list of lists, slicing_description[i][j][k] giving the numpy array</span>
<span class="sd">                                    for interval i,j,k (in this 3 with 3 joint slicing coordinates)</span>
<span class="sd">            interval_dimension: dimension number (in new numbering) for the intervals</span>
<span class="sd">            in_interval_dimension: dimension number (in new numbering) inside the intervals</span>
<span class="sd">            n_int: Number of intervals</span>
<span class="sd">            n_in_int: number of elements in intervals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slicing_coord_names</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">joint_slices</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">slicing_coord_names</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="n">slicing_coord_names</span> <span class="o">+=</span> <span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># This will contain a list of coordinate indices which has to be deleted at the end</span>
        <span class="n">del_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_check_coord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)):</span>
            <span class="n">check_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i_check_coord</span><span class="p">]</span>

            <span class="c1"># Do nothing for scalar dimension</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Determine common dimension list of this coordinate with the sliced ones</span>
            <span class="c1"># and the oned which will remain after removing the sliced ones</span>
            <span class="n">common_dims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># the next list contains the indices to commoon_dims in check_coord.dimension_list</span>
            <span class="n">common_dims_index</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remaining_dimension_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i_d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i_d</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">joint_dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">common_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">common_dims_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_d</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">remaining_dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># This coordinate has common dimension with the flattened dimensions</span>
                <span class="c1"># This coordinate &lt;c&gt; will be replaced by .</span>
                <span class="c1"># &lt;c&gt; this coordinate name</span>
                <span class="c1"># Rel. &lt;x&gt; in interval</span>
                <span class="c1"># Start &lt;x&gt; in interval</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                    <span class="c1"># These coordinates make sense only for numerical values</span>
                    <span class="c1"># For string the original coordinate will be kept</span>
                    <span class="n">cc_new_in_int</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Rel. &quot;</span> <span class="o">+</span>
                                                                            <span class="n">check_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span>
                                                                            <span class="s2">&quot; in int(&quot;</span><span class="o">+</span>
                                                                            <span class="n">slicing_coord_names</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                                                                            <span class="n">unit</span><span class="o">=</span><span class="n">check_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
                                                                            <span class="n">mode</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mode</span><span class="p">)))</span>
                    <span class="n">add_in_int_coord</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cc_new_int</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Start &quot;</span> <span class="o">+</span>
                                                                          <span class="n">check_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span>
                                                                          <span class="s2">&quot; in int(&quot;</span> <span class="o">+</span>
                                                                          <span class="n">slicing_coord_names</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                                                                          <span class="n">unit</span><span class="o">=</span><span class="n">check_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
                                                                          <span class="n">mode</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mode</span><span class="p">)))</span>
                    <span class="n">add_int_coord</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">del_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_check_coord</span><span class="p">)</span>
                    <span class="n">change_check_coord</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">add_in_int_coord</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">add_int_coord</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">change_check_coord</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">coord_int_filled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">coord_in_int_filled</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)):</span>
                        <span class="c1"># in this case the coordinate for the interval starts will be equidistant</span>
                        <span class="c1"># This means that common_dims has only 1 element. Adding the steps to the</span>
                        <span class="c1"># first selected element to the start value</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span>    \
                                            <span class="o">+</span> <span class="n">slice_description</span><span class="o">.</span><span class="n">start</span>  \
                                              <span class="o">*</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="n">common_dims_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="c1"># Increrasing the step size</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="p">[</span><span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="n">common_dims_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>\
                                                                <span class="o">*</span> <span class="n">slice_description</span><span class="o">.</span><span class="n">step</span><span class="p">]</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span>
                        <span class="c1"># The dimmension list will be the same as check_coords, except that</span>
                        <span class="c1"># the common_dim is replaced by the interval dimension</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">common_dims_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interval_dimension</span>
                        <span class="n">coord_int_filled</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span>
                              <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="c1"># The coordinate in the intervals will be equidistant and the same in all intervals</span>
                        <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">start</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="n">common_dims_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span>
                        <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_interval_dimension</span><span class="p">]</span>
                        <span class="n">coord_in_int_filled</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">coord_int_filled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">coord_in_int_filled</span><span class="p">):</span>
                    <span class="c1"># We need to get the coordinate data and extract the coordinates</span>
                    <span class="n">unified_dimensions</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unify_list</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">,</span> <span class="n">joint_dimension_list</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unified_dimensions</span><span class="p">:</span>
                        <span class="n">index</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                    <span class="n">coord_data</span><span class="p">,</span> <span class="n">data_low</span><span class="p">,</span> <span class="n">data_high</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">original_shape</span><span class="p">,</span>
                                                                       <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                    <span class="c1"># The shape of the unified dimension space</span>
                    <span class="n">unified_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">original_shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unified_dimensions</span><span class="p">]</span>
                    <span class="c1"># Reshaping to this shape, other dimensions have 1 element which will be removed</span>
                    <span class="n">coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coord_data</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">unified_shape</span><span class="p">))</span>
                    <span class="c1"># Determining indices in unified dimension list which are flattened</span>
                    <span class="n">flattened_in_unified</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i_d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unified_dimensions</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">joint_dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">unified_dimensions</span><span class="p">[</span><span class="n">i_d</span><span class="p">])</span>
                            <span class="n">flattened_in_unified</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_d</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># Flattening these dimensions in the coordinate data matrix</span>
                    <span class="n">coord_data</span><span class="p">,</span> <span class="n">flat_dim_mapping</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">coord_data</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">add_int_coord</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coord_int_filled</span><span class="p">):</span>
                    <span class="c1"># Filling data for the in-interval coordinate</span>
                    <span class="c1"># Creating a list of slices for all dimension, so as all elements are copied</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># In the flattened dimensions inserting the slicing index array</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">slice_description</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">slice_description</span><span class="p">[</span><span class="s1">&#39;Starts&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slice_description</span><span class="p">),</span>
                                                   <span class="n">dtype</span><span class="o">=</span><span class="n">slice_description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)):</span>
                                <span class="n">start_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_description</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">start_ind</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">data_low</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">,</span>
                                            <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">data_low</span><span class="p">,</span>
                                                           <span class="n">data_high</span> <span class="o">-</span> <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                    <span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cc_new_int</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                             <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                             <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                        <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">cc_new_int</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">remaining_dimension_list</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping. None dimension.&quot;</span><span class="p">)</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval_dimension</span><span class="p">)</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
                        <span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">cc_new_int</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multi-dimension multi-slicing is not implemented yet.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">add_in_int_coord</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coord_in_int_filled</span> <span class="ow">or</span> <span class="n">change_check_coord</span><span class="p">):</span>
                    <span class="c1"># Here the coordinate will change in the remaining_dimensions and both the</span>
                    <span class="c1"># interval_dimension and in_interval_dimension</span>
                    <span class="c1">#  Determining the shape of the output matrix</span>
                    <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="c1"># Removing the flattened shape</span>
                    <span class="k">del</span> <span class="n">new_shape</span><span class="p">[</span><span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="c1"># Moving the flattened dimension to the end in the existing coord data</span>
                    <span class="n">coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">coord_data</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data_high</span><span class="p">,</span> <span class="n">flattened_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Creating an index list for the source array</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="c1"># Adding two new dimensions for the intervals and the data in the intervals</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">)</span>
                            <span class="n">in_interval_dimension_in_coord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_int</span><span class="p">)</span>
                            <span class="n">interval_dimension_in_coord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="c1">#Creating a new data array with this new_shape</span>
                            <span class="n">new_coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dtype</span><span class="p">())</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="n">new_data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data_low</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                                <span class="n">new_data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data_high</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_data_low</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">new_data_high</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="c1"># Creating an index list for the destination array</span>
                            <span class="n">ind_out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Going through the elements in the intervals</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">):</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension_in_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_description</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                                          <span class="n">slice_description</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                          <span class="n">slice_description</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">interval_dimension_in_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">):</span>
                                    <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="c1">#USED TO BE new_data but that is undefined</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="n">new_data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                    <span class="n">new_data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_data_low</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">new_data_high</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If slice_description is dict or numpy array</span>
                            <span class="c1"># Adding two new dimensions for the intervals and the data in the intervals</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_int</span><span class="p">)</span>
                            <span class="n">interval_dimension_in_coord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">)</span>
                            <span class="n">in_interval_dimension_in_coord</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="c1">#Creating a new data array with this new_shape</span>
                            <span class="n">new_coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dtype</span><span class="p">())</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="n">new_data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data_low</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                                <span class="n">new_data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data_high</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                            <span class="c1"># Creating an index list for the destination array</span>
                            <span class="n">ind_out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Going through the intervals</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_int</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_description</span><span class="p">[</span><span class="s1">&#39;Starts&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                              <span class="n">slice_description</span><span class="p">[</span><span class="s1">&#39;Stops&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                                    <span class="n">s_out</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">slice_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="n">s_out</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">interval_dimension_in_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension_in_coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_out</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                                    <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> \
                                                                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="n">new_data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                    <span class="n">new_data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_data_low</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">new_data_high</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">n_in_int</span><span class="p">):</span>
                                    <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension_in_coord</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="n">n_in_int</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                                        <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dtype</span><span class="p">()</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">):</span>
                                            <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># There is no NaN for integer, we put in 0. There is no other solution</span>
                                            <span class="n">new_coord_data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">new_data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                            <span class="n">new_data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                                            <span class="n">new_data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                            <span class="c1"># Moving the interval dimension to the end</span>
                            <span class="n">new_coord_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">new_coord_data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="n">data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_low</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_low</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data_high</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_low</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_high</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">interval_dimension_in_coord</span><span class="p">,</span> <span class="n">in_interval_dimension_in_coord</span> \
                                 <span class="o">=</span> <span class="n">in_interval_dimension_in_coord</span><span class="p">,</span> <span class="n">interval_dimension_in_coord</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">add_in_int_coord</span><span class="p">):</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">new_coord_data</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">new_data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                    <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">new_coord_data</span> <span class="o">-</span> <span class="n">new_data_low</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_coord_data</span> <span class="o">-</span> <span class="n">new_data_low</span><span class="p">,</span>
                                                                  <span class="n">new_data_high</span> <span class="o">-</span> <span class="n">new_coord_data</span><span class="p">]</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">remaining_dimension_list</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cc_new_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping. None dimension.&quot;</span><span class="p">)</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_interval_dimension</span><span class="p">)</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval_dimension</span><span class="p">)</span>
                            <span class="n">mode</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
                            <span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">cc_new_in_int</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">change_check_coord</span><span class="p">):</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span>  <span class="n">new_coord_data</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">new_data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                    <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">new_coord_data</span> <span class="o">-</span> <span class="n">new_data_low</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_coord_data</span> <span class="o">-</span> <span class="n">new_data_low</span><span class="p">,</span>
                                                                <span class="n">new_data_high</span> <span class="o">-</span> <span class="n">new_coord_data</span><span class="p">]</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">remaining_dimension_list</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping. None dimension.&quot;</span><span class="p">)</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_interval_dimension</span><span class="p">)</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval_dimension</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multi-slice along multiple dimensions is not suported yet.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">add_in_int_coord</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc_new_in_int</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">add_int_coord</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc_new_int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There are no common dimensions</span>
                <span class="n">new_dimension_list</span> <span class="o">=</span> \
                        <span class="p">[</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">new_dimension_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping. None dimension.&quot;</span><span class="p">)</span>
                <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span> <span class="o">=</span> <span class="n">new_dimension_list</span>
        <span class="n">new_coord_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">del_coords</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">new_coord_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_coord_list</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Interval(&quot;</span> <span class="o">+</span> <span class="n">slicing_coord_names</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                                                     <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;[n.a.]&quot;</span><span class="p">,</span>
                                                     <span class="n">mode</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">CoordinateMode</span><span class="p">(</span><span class="n">equidistant</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                                                     <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">dimension_list</span> <span class="o">=</span> <span class="n">interval_dimension</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Interval(&quot;</span> <span class="o">+</span> <span class="n">slicing_coord_names</span> <span class="o">+</span> <span class="s2">&quot;) sample index&quot;</span><span class="p">,</span>
                                                     <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;[n.a.]&quot;</span><span class="p">,</span>
                                                     <span class="n">mode</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">CoordinateMode</span><span class="p">(</span><span class="n">equidistant</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                                                     <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">dimension_list</span> <span class="o">=</span> <span class="n">in_interval_dimension</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>


<div class="viewcode-block" id="DataObject.slice_data"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.slice_data">[docs]</a>    <span class="k">def</span> <span class="nf">slice_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slicing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">summing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice (select areas) from the data object along one or more coordinates.</span>
<span class="sd">        Return the sliced object.</span>
<span class="sd">          slicing:</span>
<span class="sd">              Dictionary with keys referring to coordinates in the data object.</span>
<span class="sd">                 Values can be:</span>
<span class="sd">                     a:SIMPLE SLICE: cases when closest value or interpolated value is selected.</span>
<span class="sd">                         a1 slice objects, range objects, scalars, lists, numpy array.</span>
<span class="sd">                         a2 flap.DataObjects without error and with data unit.name equal to</span>
<span class="sd">                            the coordinate</span>
<span class="sd">                         a3 flap.DataObject with the name of one coordinate equal to the dictionary</span>
<span class="sd">                            key without having value_ranges values.</span>
<span class="sd">                         a4 flap.Intervals objects with one interval</span>
<span class="sd">                     b: MULTI SLICE: Various range selection objects. In this case ranges are</span>
<span class="sd">                        selected and a new dimension is added to the data array</span>
<span class="sd">                        (only of more than 1 interval is selected) going through the</span>
<span class="sd">                        intervals. If intervals are of different length the longest will be used</span>
<span class="sd">                        and missing elements filled with float(&#39;nan&#39;).</span>
<span class="sd">                        Two new coordinates are added: &quot;&lt;coordinate&gt; in interval&quot;,</span>
<span class="sd">                        &quot;&lt;coordinate&gt; interval&quot;</span>
<span class="sd">                        b1 flap.Intervals objects with more than one interval</span>
<span class="sd">                        b2 flap.DataObjects with data unit.name equal to the slicing coordinate. The error</span>
<span class="sd">                           values give the intervals.</span>
<span class="sd">                        b3 flap.DataObject with the name of one coordinate equal to the slicing coordinate.</span>
<span class="sd">                           The value_ranges select the intervals.</span>
<span class="sd">                        If range slicing is done with multiple coordinates which have common element in the</span>
<span class="sd">                        dimension list they will be done in one step. Otherwise the slicing is done sequentially.</span>
<span class="sd">          summing:</span>
<span class="sd">              Summing is applied to the sliced data. It processes data along one coordinate</span>
<span class="sd">              and the result is a scalar. This way summing reduces the number of dimensions.</span>
<span class="sd">              Dictionary with keys referring to coordinates and values as processing strings. If</span>
<span class="sd">              the processed coordinate changes along multiple dimensions those dimensions will be flattened.</span>

<span class="sd">              For mean and avereage data errors are calculated as error of independent variables, that is taking the square</span>
<span class="sd">              root of the squared sum of errors. For coordinates the mean of the ranges is taken.</span>

<span class="sd">              Processing strings are the following:</span>
<span class="sd">                       None: Nothing to be done in this dimension</span>
<span class="sd">                      &#39;Mean&#39; : take mean of values in selection/coordinate</span>
<span class="sd">                      &#39;Sum&#39;  : take sum of values in selection/coordinate</span>
<span class="sd">                      &#39;Min&#39;  : take the minimum of the values/coordinate</span>
<span class="sd">                      &#39;Max&#39;  : take the maximum of the values/coordinate</span>

<span class="sd">          options: &#39;Partial intervals&#39;  (bool). If true processes intervals which extend over the coordinate limits. </span>
<span class="sd">                                                If false only full intervals are processed.</span>
<span class="sd">                   &#39;Slice type&#39;: &#39;Simple&#39;: Case a above: closest or interpolated values are selected, dimensions </span>
<span class="sd">                                           are reduced or unchanged.</span>
<span class="sd">                                 &#39;Multi&#39;: Case b above: multiple intervals are selected and their data is placed into</span>
<span class="sd">                                          new dimension.</span>
<span class="sd">                                 None: Automatically select. For slicing data in case b multi slice, otherwise simple</span>
<span class="sd">                   &#39;Interpolation: &#39;Closest value&#39;</span>
<span class="sd">                                   &#39;Linear&#39;</span>
<span class="sd">                   &#39;Regenerate coordinates&#39;: True/False  (defaultL True)</span>
<span class="sd">                                             If True and summing is done then looks for pairs of coordinates</span>
<span class="sd">                                             &#39;Rel. &lt;coord&gt; in int(&lt;coord1&gt;)&#39;  &#39;Start &lt;coord&gt; in int(&lt;coord1&gt;)&#39;.</span>
<span class="sd">                                             If such pairs are found and they change on the same dimension or one of them is constant then</span>
<span class="sd">                                             coordinate &lt;coord&gt; is regenerated and these are removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Partial intervals&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="s1">&#39;Slice type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;Interpolation&#39;</span><span class="p">:</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Regenerate coordinates&#39;</span><span class="p">:</span> <span class="kc">True</span>
                           <span class="p">}</span>
        <span class="n">_options</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_options</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s1">&#39;Slicing&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">find_str_match</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Simple&#39;</span><span class="p">,</span><span class="s1">&#39;Multi&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">find_str_match</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Closest value&#39;</span><span class="p">,</span><span class="s1">&#39;Linear&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        
                
        <span class="k">def</span> <span class="nf">check_multi_slice</span><span class="p">(</span><span class="n">slicing</span><span class="p">,</span> <span class="n">coord_dim</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Determines whether this slicing operation is multi-slice</span>
<span class="sd">                slicing: the slicing list or dictionary element</span>
<span class="sd">                coord_dim: Coordinate name in case of coordinate slincing,</span>
<span class="sd">                           dimension index in case of dimension slicing.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">range</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">coord_dim</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coord_dim</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To use a flap.DataObject for slicing either the data_unit.name or a coordinate name should be identical to the coordinate.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid slicing description.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">simple_slice_index</span><span class="p">(</span><span class="n">slicing</span><span class="p">,</span> <span class="n">slicing_coord</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">_options</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Returns index array which can be used for indexing the selected elements in the</span>
<span class="sd">                data array flattened in the dimensions of the coordinate.</span>

<span class="sd">                Assumes simple (non-range) slicing.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="c1"># There is a chance to slice with slice object if the coordinate is equidistant</span>
                <span class="c1"># Creating a slice object (regular_slice) if the slicing description can be described</span>
                <span class="c1"># with it. Later it will be checked whether it is consistent with the equidistant coordinate.</span>
                <span class="c1"># regular_slice is in coordinate units.</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">range</span><span class="p">))</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                    <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># This coordinate is constant then simple slice will select this element anyway</span>
                        <span class="k">return</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                        <span class="c1"># This coordinate changes in one dimension equidistantly</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                                                 <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                              <span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">)</span> 
                    <span class="c1"># Regular slice is possible only with a single interval</span>
                    <span class="ow">and</span> <span class="p">((</span><span class="n">slicing</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If regular_slice exists</span>
                <span class="n">regular_slice</span>
                <span class="n">regular_slice_exists</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="n">regular_slice_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice_exists</span><span class="p">):</span>
                <span class="c1"># Checking if regular_slice and coordinate have common range</span>
                <span class="n">slicing_coord_stop</span> <span class="o">=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">start</span> \
                                     <span class="o">+</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                                       <span class="o">*</span> <span class="p">(</span><span class="n">data_shape</span><span class="p">[</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">range_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">range_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
                <span class="n">range_coord</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing_coord_stop</span><span class="p">]),</span>
                               <span class="nb">max</span><span class="p">([</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing_coord_stop</span><span class="p">])]</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">range_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">range_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data in slicing range.&quot;</span><span class="p">)</span>
                <span class="c1"># Checking whether the step of regular_slice is nearly the integer multiple of</span>
                <span class="c1"># the coordinate step size</span>
                <span class="n">n_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">min</span><span class="p">([</span><span class="n">range_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                          <span class="o">-</span> <span class="nb">max</span><span class="p">([</span><span class="n">range_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>  \
                         <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>
                <span class="n">step_diff</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>   \
                            <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">step_diff</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_step</span> <span class="o">&gt;</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">regular_slice</span>
                    <span class="n">regular_slice_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If interpolation is desired and the new point don&#39;t fall onto old one we cannot use slice</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>
                        <span class="p">):</span>
                        <span class="k">del</span> <span class="n">regular_slice</span>
                        <span class="n">regular_slice_exists</span> <span class="o">=</span> <span class="kc">False</span>
 
            <span class="c1"># At this point if we have a regular_slice object than it is possible to use slicing</span>
            <span class="c1"># in the data array. Otherwise we will create a numpy array for indexing</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice_exists</span><span class="p">):</span>
                <span class="c1"># Limiting regular slice within the data range</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">((</span><span class="nb">int</span><span class="p">((</span><span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>  \
                                                  <span class="o">/</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span>   \
                                              <span class="o">+</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                              <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="nb">int</span><span class="p">((</span><span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>  \
                                                  <span class="o">/</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">*</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span>   \
                                              <span class="o">+</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                             <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">((</span><span class="nb">int</span><span class="p">((</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  \
                                                  <span class="o">/</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span>   \
                                              <span class="o">+</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                              <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">regular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="nb">int</span><span class="p">((</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  \
                                                  <span class="o">/</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">*</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span>   \
                                              <span class="o">+</span> <span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

                <span class="n">start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">step_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">stop_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">regular_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">range_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">stop_index</span><span class="p">,</span> <span class="n">step_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># slice object could not be created for data array</span>
                <span class="c1"># Creating flattened coordinate data array</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                <span class="n">coord_data</span><span class="p">,</span> <span class="n">coord_low</span><span class="p">,</span> <span class="n">coord_high</span> <span class="o">=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="n">coord_data</span> <span class="o">=</span> <span class="n">coord_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">interval_slice</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="c1"># Data error ranges are considered as intervals</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">e</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">int_l</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">e</span>
                                <span class="n">int_h</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">e</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">el</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">eh</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">int_l</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">el</span>
                                <span class="n">int_h</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">eh</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot slice with coordinate changing along multiple dimensions.&quot;</span><span class="p">)</span>
                            <span class="n">d</span><span class="p">,</span> <span class="n">int_l</span><span class="p">,</span> <span class="n">int_h</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="o">=...</span><span class="p">,</span><span class="n">data_shape</span><span class="o">=</span><span class="n">slicing</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">int_l</span>
                        <span class="n">slicing_intervals</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">int_l</span><span class="p">,</span><span class="n">int_h</span><span class="p">)</span>
                        <span class="n">interval_slice</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
                    <span class="n">slicing_intervals</span> <span class="o">=</span> <span class="n">slicing</span>
                    <span class="n">interval_slice</span> <span class="o">=</span> <span class="kc">True</span>
                     
                <span class="k">if</span> <span class="p">(</span><span class="n">interval_slice</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot slice string coordinate with numeric intervals.&quot;</span><span class="p">)</span>
                    <span class="c1"># Determining the interval limits which are within the coordinate data range </span>
                    <span class="n">dr</span><span class="p">,</span> <span class="n">dre</span> <span class="o">=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">int_l</span><span class="p">,</span> <span class="n">int_h</span> <span class="o">=</span> <span class="n">slicing_intervals</span><span class="o">.</span><span class="n">interval_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">dr</span><span class="p">,</span><span class="n">partial_intervals</span><span class="o">=</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Partial intervals&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c1"># Creating a numpy array with the indices within the intervals</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">int_l</span><span class="p">)):</span>
                        <span class="n">where_start</span> <span class="o">=</span> <span class="n">coord_data</span> <span class="o">&gt;=</span> <span class="n">int_l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">where_stop</span> <span class="o">=</span> <span class="n">coord_data</span> <span class="o">&lt;=</span> <span class="n">int_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where_start</span><span class="p">,</span><span class="n">where_stop</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">index</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>    
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No elements found in slicing interval(s).&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">index</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Creating numpy array from all slicing descriptions. The values are in coordinate units</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">range</span><span class="p">)):</span>
                        <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">slicing</span><span class="p">)):</span>
                        <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slicing</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span>  <span class="nb">slice</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">slicing</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                            <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                        <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                            <span class="n">index</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>    
                        <span class="n">slicing_arr</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                    <span class="c1"># Creating an ind_coord array with the indices into the data array</span>
                    <span class="c1"># This might be a float value as interpolation might need a non-integer index</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">slicing_arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot do interpolation with string values.&quot;</span><span class="p">)</span>
                        <span class="c1"># For strings requiring exact match but wildcards are allowed</span>
                        <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">coord_data_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">coord_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_data</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_arr</span><span class="p">)):</span>
                            <span class="n">selected_str</span><span class="p">,</span> <span class="n">select_ind</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">select_signals</span><span class="p">(</span><span class="n">coord_data_list</span><span class="p">,</span> <span class="p">[</span><span class="n">slicing_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                            <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind_coord</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">select_ind</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_coord</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No matching elements found in slicing.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">)</span>
                             <span class="ow">and</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
                            <span class="n">ind_coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">slicing_arr</span> <span class="o">-</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">step</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_coord</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_coord</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slicing is out of coordinate range.&quot;</span><span class="p">)</span>
                                <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">ind_coord</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_coord</span> <span class="o">&gt;=</span> <span class="n">data_shape</span><span class="p">[</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_coord</span> <span class="o">&lt;</span> <span class="n">data_shape</span><span class="p">[</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slicing is out of coordinate range.&quot;</span><span class="p">)</span>
                                <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">ind_coord</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Checking for monotonicity of coordinate</span>
                            <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">coord_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="c1"># If monotonous interpolating the coordinate-index function</span>
                                <span class="n">data_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coord_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                                <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">slicing_arr</span><span class="p">,</span><span class="n">coord_data</span><span class="p">,</span><span class="n">data_index</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Otherwise looking for closest match for each element</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate is non-monotonous, cannot interpolate.&quot;</span><span class="p">)</span>
                                <span class="n">ind_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_arr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_arr</span><span class="p">)):</span>
                                    <span class="n">ind_coord</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coord_data</span> <span class="o">-</span> <span class="n">slicing_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">ind_coord</span>

        <span class="k">def</span> <span class="nf">check_slicing_type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">,</span> <span class="n">slicing_coord</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Check if the slicing description is compatible with the coordinate</span>
<span class="sd">                Raise TypeError is not.</span>
<span class="sd">                Returns the slicing type &#39;Numeric&#39; or &#39;String&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">range</span><span class="p">)):</span>
                <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)):</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Changing types in slicing list.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)):</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
                <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">dtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)):</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slicing_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">slicing_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                <span class="n">coord_type</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coord_type</span> <span class="o">=</span> <span class="s1">&#39;Numeric&#39;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">coord_type</span> <span class="o">!=</span> <span class="n">slicing_type</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incompatible slicing and coordinate values.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">slicing_type</span>


        <span class="c1"># **************** slice starts here ***********************</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot slice data object without data.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">partial_intervals</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;Partial intervals&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">partial_intervals</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">d_slice</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Checking whether these coordinates are present</span>
            <span class="n">slicing_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">slicing_coord_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">range_slice</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">slicing_description</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">slicing_coord_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                    <span class="n">slicing_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
                    <span class="c1"># Multi-slice is called range_slice in this program</span>
                    <span class="n">range_slice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_multi_slice</span><span class="p">(</span><span class="n">slicing</span><span class="p">[</span><span class="n">sc</span><span class="p">],</span> <span class="n">sc</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">range_slice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Multi&#39;</span><span class="p">)):</span>
                            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;Multi slice not possible with this description.&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Slice type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Simple&#39;</span><span class="p">):</span>
                            <span class="n">range_slice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">slicing_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slicing</span><span class="p">[</span><span class="n">sc</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slicing coordinate &quot;</span><span class="o">+</span><span class="n">sc</span><span class="o">+</span><span class="s2">&quot; is not present in data object.&quot;</span><span class="p">)</span>

            <span class="c1"># Checking whether the same coordinate appears more than once</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">slicing</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i1</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot slice twice with the same coordinate.&quot;</span><span class="p">)</span>

            <span class="c1"># Checking for common dimensions in slicing coordinates where both slicing is range type</span>
            <span class="n">common_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">slicing</span><span class="p">)),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i_sc1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i_sc2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">i_sc1</span> <span class="o">!=</span> <span class="n">i_sc2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">range_slice</span><span class="p">[</span><span class="n">i_sc1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">range_slice</span><span class="p">[</span><span class="n">i_sc2</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc1</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc2</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                                <span class="n">common_dims</span><span class="p">[</span><span class="n">i_sc1</span><span class="p">,</span><span class="n">i_sc2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>

            <span class="c1"># dependent multi slices (ones with common dimension) will be processed in one step,</span>
            <span class="c1"># therefore we need to keep track which one was processed.</span>
            <span class="n">slice_processed</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">)</span>

            <span class="c1"># Making a copy of options. Interpolation will be set to closest value if string slice is used</span>
            <span class="n">save_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_options</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i_sc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">)):</span>
                <span class="n">_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">save_options</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">slice_processed</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">check_slicing_type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">],</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="s1">&#39;String&#39;</span><span class="p">):</span>
                    <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Closest value&#39;</span>
                    

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">range_slice</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]):</span>
                    <span class="c1"># This is a simple slice</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># This coordinate is constant</span>
                        <span class="c1">#raise NotImplementedError(&quot;Slicing on constant coordinates is not immplemented.&quot;)</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Determine slicing index in the flattened coordinate dimensions</span>
                        <span class="n">ind_slice_coord</span> <span class="o">=</span> <span class="n">simple_slice_index</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">],</span>
                                                             <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">],</span>
                                                             <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                             <span class="n">_options</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c1"># Flatten the data array along the coordinate dimensions</span>
                    <span class="n">d_flat</span><span class="p">,</span> <span class="n">dimension_mapping</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                                            <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">d_err_flat_1</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                            <span class="n">d_err_flat_2</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                           <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_err</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                                    <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                    <span class="c1"># Create a list of slices for each dimension for the whole array</span>
                    <span class="n">ind_slice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">d_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d_flat</span><span class="o">.</span><span class="n">ndim</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Closest value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)):</span>
                        <span class="c1"># Insert the slicing indices into the flattened dimension</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="n">ind_slice</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ind_slice</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="c1"># Slice the data with this index list</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d_flat</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">d_err_flat_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d_err_flat_1</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)])</span>
                                <span class="n">d_err_flat_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d_err_flat_2</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d_err</span>  <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d_err</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)])</span>                        
                    <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Linear&#39;</span><span class="p">):</span>
                        <span class="c1"># ind_slice_coord is numpy array</span>
                        <span class="n">ind_slice_coord_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">ind_slice_coord</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                        <span class="n">ind_slice_coord_2</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="c1"># Checking if the index is above the limit. This can happen at the end</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_slice_coord_2</span> <span class="o">&gt;=</span> <span class="n">d_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">ind_slice_coord_2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> 
                        <span class="c1"># Insert the lower slicing indices into the flattened dimension and get the two base points</span>
                        <span class="c1"># for interpolation</span>
                        <span class="n">ind_slice_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)</span>
                        <span class="n">ind_slice_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">)</span>
                        <span class="n">ind_slice_1</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span>
                        <span class="n">d1</span> <span class="o">=</span> <span class="n">d_flat</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                        <span class="n">ind_slice_2</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_slice_coord_2</span>
                        <span class="n">d2</span> <span class="o">=</span> <span class="n">d_flat</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                        <span class="c1"># Reshaping ind_slice_coord_1 and ind_slice_coord to an array with 1 elements in all</span>
                        <span class="c1"># dimensions except the coordinate dimendsion. This will broadcast with d2 and d2.</span>
                        <span class="n">interpol_weight_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">interpol_weight_shape</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> \
                                                                 <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">ind_slice_interp_1</span> <span class="o">=</span> <span class="n">ind_slice_coord_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">interpol_weight_shape</span><span class="p">))</span>  
                        <span class="n">ind_slice_interp</span> <span class="o">=</span> <span class="n">ind_slice_coord</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">interpol_weight_shape</span><span class="p">))</span>                                        
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">d_err_flat_1_1</span> <span class="o">=</span> <span class="n">d_err_flat_1</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                                <span class="n">d_err_flat_1_2</span> <span class="o">=</span> <span class="n">d_err_flat_1</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                                <span class="n">d_err_flat_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_err_flat_1_2</span> <span class="o">-</span> <span class="n">d_err_flat_1_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_err_flat_1_1</span>
                                <span class="n">d_err_flat_2_1</span> <span class="o">=</span> <span class="n">d_err_flat_2</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                                <span class="n">d_err_flat_2_2</span> <span class="o">=</span> <span class="n">d_err_flat_2</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                                <span class="n">d_err_flat_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_err_flat_2_2</span> <span class="o">-</span> <span class="n">d_err_flat_2_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_err_flat_2_1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d_err_1</span> <span class="o">=</span> <span class="n">d_err</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_1</span><span class="p">)]</span>
                                <span class="n">d_err_2</span> <span class="o">=</span> <span class="n">d_err</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_slice_2</span><span class="p">)]</span>
                                <span class="n">d_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_err_2</span> <span class="o">-</span> <span class="n">d_err_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind_slice_interp</span> <span class="o">-</span> <span class="n">ind_slice_interp_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d_err_1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal error: cannot handle interpolation method &#39;</span><span class="si">{:s}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Interpolation&#39;</span><span class="p">]))</span>
                    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span>
                    <span class="c1"># If the sliced data contains only 1 element removing this dimension</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">sliced_removed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sliced_removed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="n">dimension_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">sliced_dimensions</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">sliced_removed</span><span class="p">):</span>
                                <span class="n">d_err_flat_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_err_flat_1</span><span class="p">)</span>
                                <span class="n">d_err_flat_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_err_flat_2</span><span class="p">)</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_err_flat_1</span><span class="p">,</span> <span class="n">d_err_flat_2</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_err</span><span class="p">)</span>
                            
                    <span class="c1"># Determining whether the slicing description results in equidistant coordinate in the </span>
                    <span class="c1"># slicing coordinate. </span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> 
                        <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">range</span><span class="p">)</span>
                        <span class="p">):</span>
                       <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span> \
                          <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coord_names</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>
                          <span class="p">):</span>
                        <span class="n">coord</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coord_names</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">False</span>  
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># This is an interval slice case</span>
                            <span class="n">d</span><span class="p">,</span><span class="n">dl</span><span class="p">,</span><span class="n">dh</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="o">=...</span><span class="p">,</span><span class="n">data_shape</span><span class="o">=</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="c1"># if one interval is cut from an equidistant interval than the result is equidistant</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> 
                                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> 
                                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">False</span>     
                    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span> \
                          <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coord_names</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>
                          <span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">False</span>            
                    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">)</span> <span class="ow">and</span>
                          <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">interval_number</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
                          <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
                          <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span>
                          <span class="p">):</span>
                        <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">slicing_equidistant</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Doing changes to all coordinates</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">__check_coords_after_simple_slice</span><span class="p">(</span><span class="n">sliced_dimensions</span><span class="p">,</span> 
                                                              <span class="n">sliced_removed</span><span class="p">,</span> 
                                                              <span class="n">ind_slice_coord</span><span class="p">,</span>
                                                              <span class="n">original_shape</span><span class="p">,</span> 
                                                              <span class="n">dimension_mapping</span><span class="p">,</span>
                                                              <span class="n">slicing_equidistant</span><span class="p">,</span>
                                                              <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">],</span>
                                                              <span class="n">_options</span><span class="p">)</span>

                    <span class="n">slice_processed</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This is multi slice</span>
                    <span class="n">joint_slices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">common_dims</span><span class="p">[</span><span class="n">i_sc</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">joint_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_sc</span><span class="p">)</span>
                    <span class="n">joint_dimension_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">joint_slices</span><span class="p">:</span>
                        <span class="n">joint_dimension_list</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unify_list</span><span class="p">(</span><span class="n">joint_dimension_list</span><span class="p">,</span>
                                                                     <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span>
                    <span class="c1">#flattening data for the joint_dimensions</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dimension_mapping</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">joint_dimension_list</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">err_flat</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                <span class="n">err</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">joint_dimension_list</span><span class="p">)</span>
                                <span class="n">err_flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">err_flat</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">joint_dimension_list</span><span class="p">)</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">err_flat</span>

                    <span class="c1"># Converting all slicing descriptions to Intervals object</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">joint_slices</span><span class="p">:</span>
                        <span class="c1"># Getting the range of the slicing coordinate</span>
                        <span class="n">r</span><span class="p">,</span> <span class="n">r_ext</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">original_shape</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">err1</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">err2</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">err1</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">err2</span> <span class="o">=</span> <span class="n">err1</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">err1</span><span class="p">,</span> <span class="n">data</span><span class="o">+</span><span class="n">err2</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)</span> <span class="ow">and</span>
                              <span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">coord_obj</span> <span class="o">=</span> <span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">e</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot do multi-slice with string type coordinate.&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot do multi-slice with coordinate changing along multiple dimensions.&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                    <span class="n">start</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">start</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">value_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">start</span><span class="p">,</span>
                                                                           <span class="n">stop</span><span class="p">,</span>
                                                                           <span class="n">step</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">number</span><span class="o">=</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">c</span><span class="p">,</span> <span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">e</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Intervals</span><span class="p">):</span>
                            <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slicing_description</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="c1"># This is an index to get the data for the joined dimensions</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
                    <span class="k">for</span> <span class="n">i_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">joint_dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i_dim</span><span class="p">)</span>
                            <span class="n">index</span><span class="p">[</span><span class="n">i_dim</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># If slicing is along a single coordinatge then three types of indexing are possible:</span>
                        <span class="c1"># slice, interval list, index list</span>
                        <span class="n">slice_type_processing</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> \
                                                <span class="ow">and</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">regular</span><span class="p">()</span> \
                                                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  \
                                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">partial_intervals</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">slice_type_processing</span><span class="p">):</span>
                            <span class="c1"># Checking whether the step size of the intervals is multiple times the step size of the coordinate</span>
                            <span class="n">d_range</span><span class="p">,</span> <span class="n">d_range_ext</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="n">n_int</span><span class="p">,</span> <span class="n">start_int</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">interval_number</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">d_range</span><span class="p">,</span>
                                                                            <span class="n">partial_intervals</span><span class="o">=</span><span class="n">partial_intervals</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="o">-</span> <span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="p">)</span> <span class="o">&gt;</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-5</span><span class="p">)</span> <span class="p">:</span>
                                <span class="n">slice_type_processing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">slice_type_processing</span><span class="p">):</span>
                            <span class="c1"># In slice type processing we create a slice object</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">n_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data in intervals&quot;</span><span class="p">)</span>
                            <span class="n">n_in_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>  \
                                                    <span class="o">/</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># If the number of intervals is less than the elements in the interval it does not worth</span>
                            <span class="c1"># doing slice processing</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">n_in_int</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of samples in interval is too small.&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">n_in_int</span> <span class="o">&gt;</span> <span class="n">n_int</span><span class="p">):</span>
                                <span class="n">slice_type_processing</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">slice_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="n">slice_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="n">start_int</span>
                                               <span class="o">-</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="n">slice_stop</span> <span class="o">=</span> <span class="n">slice_start</span> <span class="o">+</span> <span class="n">n_int</span> <span class="o">*</span> <span class="n">slice_step</span>
                                <span class="n">slice_description</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_start</span><span class="p">,</span> <span class="n">slice_stop</span><span class="p">,</span> <span class="n">slice_step</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">slice_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Slice start below 0.&quot;</span><span class="p">)</span>
                        <span class="c1"># We test again if slice type is possible as it might have been changed above</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">slice_type_processing</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">)</span>  \
                                  <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
                                <span class="c1"># In this case it is possible to determine index ranges</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">d_range</span>
                                <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                                    <span class="n">d_range</span><span class="p">,</span> <span class="n">d_range_ext</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">data_range</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                <span class="n">interval_starts</span><span class="p">,</span> <span class="n">interval_stops</span>  \
                                       <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interval_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">d_range</span><span class="p">,</span>  \
                                                                   <span class="n">partial_intervals</span><span class="o">=</span><span class="n">partial_intervals</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">interval_starts</span> <span class="o">-</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                                     <span class="o">/</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                      <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                                    <span class="n">stops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">interval_stops</span> <span class="o">-</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                                     <span class="o">/</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                     <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">interval_stops</span> <span class="o">-</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                                     <span class="o">/</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                      <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                                    <span class="n">stops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">interval_starts</span> <span class="o">-</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                                     <span class="o">/</span><span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                     <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                                <span class="n">slice_description</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Starts&#39;</span><span class="p">:</span><span class="n">starts</span><span class="p">,</span> <span class="s1">&#39;Stops&#39;</span><span class="p">:</span><span class="n">stops</span><span class="p">}</span>
                                <span class="n">n_int</span> <span class="o">=</span> <span class="n">starts</span><span class="o">.</span><span class="n">size</span>
                                <span class="n">n_in_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">stops</span> <span class="o">-</span> <span class="n">starts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">n_in_int</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of samples in interval is too small.&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">starts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error: negative slicing indices.&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">stops</span> <span class="o">&gt;</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">joint_dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error: Slicing indices over end of data.&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">stops</span> <span class="o">&lt;=</span> <span class="n">starts</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error: Interval slice starts after stop.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Determining indices for each interval</span>
                                <span class="n">c_data</span><span class="p">,</span> <span class="n">c_low</span><span class="p">,</span> <span class="n">c_high</span> <span class="o">=</span> <span class="n">slicing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                                <span class="n">d_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">c_data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">c_data</span><span class="p">)]</span>
                                <span class="n">interval_starts</span><span class="p">,</span> <span class="n">interval_stops</span>  \
                                       <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interval_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">d_range</span><span class="p">,</span>  \
                                                                   <span class="n">partial_intervals</span><span class="o">=</span><span class="n">partial_intervals</span><span class="p">)</span>
                                <span class="n">c_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">c_data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="n">slice_description</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">n_max</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">i_int</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">interval_starts</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">c_data</span> <span class="o">&gt;=</span> <span class="n">interval_starts</span><span class="p">[</span><span class="n">i_int</span><span class="p">],</span> \
                                                     <span class="n">c_data</span> <span class="o">&lt;=</span> <span class="n">interval_stops</span><span class="p">[</span><span class="n">i_int</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">slice_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                                    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">n_max</span><span class="p">):</span>
                                        <span class="n">n_max</span> <span class="o">=</span> <span class="n">n</span>
                                <span class="n">n_int</span> <span class="o">=</span> <span class="n">interval_starts</span><span class="o">.</span><span class="n">size</span>
                                <span class="n">n_in_int</span> <span class="o">=</span> <span class="n">n_max</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">n_in_int</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of samples in interval is too small.&quot;</span><span class="p">)</span>
                            <span class="c1"># If the interval length are very much different too much space is needed, we don&#39;t</span>
                            <span class="c1"># do slicing</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">n_in_int</span><span class="o">*</span><span class="n">n_int</span> <span class="o">&gt;</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">joint_dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interval length too much different cannot do multi-slicing.&quot;</span><span class="p">)</span>
                            <span class="c1"># Creating the new data matrix</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="c1"># Removing the flattened dimension</span>
                        <span class="k">del</span> <span class="n">new_shape</span><span class="p">[</span><span class="n">joint_dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="c1"># Moving the flattened dimension to the end</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">__moveaxis</span><span class="p">(</span><span class="n">joint_dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="c1"># Adding two new dimensions for the intervals and the data in the intervals</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">)</span>
                            <span class="n">in_interval_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_int</span><span class="p">)</span>
                            <span class="n">interval_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="c1">#Creating a new data object with this new_shape</span>
                            <span class="n">new_data_object</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DataObject</span><span class="p">())</span>
                            <span class="n">new_data_object</span><span class="o">.</span><span class="n">__create_arrays</span><span class="p">(</span><span class="n">d_slice</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_shape</span><span class="p">))</span>
                            <span class="c1"># Creating an index list for the source array</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Creating an index list for the destination array</span>
                            <span class="n">ind_out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_data_object</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Going through the elements in the intervals</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">):</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_description</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                                          <span class="n">slice_description</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                                          <span class="n">slice_description</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                                <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">interval_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_int</span><span class="p">)</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="n">new_data_object</span><span class="o">.</span><span class="n">__copy_data</span><span class="p">(</span><span class="n">d_slice</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Here we copy interval-wise</span>
                            <span class="c1"># Adding two new dimensions for the intervals and the data in the intervals</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_int</span><span class="p">)</span>
                            <span class="n">interval_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_in_int</span><span class="p">)</span>
                            <span class="n">in_interval_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="c1">#Creating a new data object with this new_shape</span>
                            <span class="n">new_data_object</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DataObject</span><span class="p">())</span>
                            <span class="n">new_data_object</span><span class="o">.</span><span class="n">__create_arrays</span><span class="p">(</span><span class="n">d_slice</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_shape</span><span class="p">))</span>
                            <span class="c1"># Creating an index list for the source array</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Creating an index list for the destination array</span>
                            <span class="n">ind_out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_data_object</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                            <span class="c1"># Going through the intervals</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_int</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">slice_description</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_description</span><span class="p">[</span><span class="s1">&#39;Starts&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                              <span class="n">slice_description</span><span class="p">[</span><span class="s1">&#39;Stops&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">s_out</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># numpy array</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">slice_description</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="n">s_out</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">interval_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_out</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="n">new_data_object</span><span class="o">.</span><span class="n">__copy_data</span><span class="p">(</span><span class="n">d_slice</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">n_in_int</span><span class="p">):</span>
                                    <span class="n">ind_out</span><span class="p">[</span><span class="n">in_interval_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="n">n_in_int</span><span class="p">)</span>
                                    <span class="n">new_data_object</span><span class="o">.</span><span class="n">__fill_nan</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_out</span><span class="p">))</span>
                            <span class="c1"># Move the interval dimension to the end</span>
                            <span class="n">new_data_object</span><span class="o">.</span><span class="n">__moveaxis</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">interval_dimension</span><span class="p">,</span> <span class="n">in_interval_dimension</span> <span class="o">=</span> <span class="n">in_interval_dimension</span><span class="p">,</span> <span class="n">interval_dimension</span>

                        <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_data_object</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">new_data_object</span><span class="o">.</span><span class="n">error</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

                        <span class="c1"># end if len(joint_slices) == 1</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Multi-slice for multiple dependent coordinates is not implemented yet.&quot;</span><span class="p">)</span>
                        <span class="c1"># Getting the data for the two coordinates</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Cannot do range slicing with more than 2 dependent coordinates.&quot;</span><span class="p">)</span>

                    <span class="c1"># Doing changes to all coordinates</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">__check_coords_after_multi_slice</span><span class="p">(</span><span class="n">slicing</span><span class="p">,</span>
                                         <span class="n">original_shape</span><span class="p">,</span>
                                         <span class="n">joint_slices</span><span class="p">,</span>
                                         <span class="n">joint_dimension_list</span><span class="p">,</span>
                                         <span class="n">dimension_mapping</span><span class="p">,</span>
                                         <span class="n">slice_description</span><span class="p">,</span>
                                         <span class="n">interval_dimension</span><span class="p">,</span>
                                         <span class="n">in_interval_dimension</span><span class="p">,</span>
                                         <span class="n">n_int</span><span class="p">,</span>
                                         <span class="n">n_in_int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">slicing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong slicing description. Use dictionary.&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">summing</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">summing_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">summing_coord_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">summing_description</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">summing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">summing_coord_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">summing_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Summing coordinate &quot;</span><span class="o">+</span><span class="n">sc</span><span class="o">+</span><span class="s2">&quot; is not present in data object.&quot;</span><span class="p">)</span>
                <span class="n">summing_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summing</span><span class="p">[</span><span class="n">sc</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i_sc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">summing_coord_names</span><span class="p">)):</span>
                <span class="n">original_shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># Do nothing if coordinate is constant</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Flattening the data array for the dimensions</span>
                <span class="n">d_flat</span><span class="p">,</span> <span class="n">dimension_mapping</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                                        <span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">err_flat_1</span><span class="p">,</span> <span class="n">dmap</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                       <span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                        <span class="n">err_flat_2</span><span class="p">,</span> <span class="n">dmap</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                       <span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">dmap</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                                          <span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Sum&#39;</span><span class="p">):</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">err_flat_1</span><span class="p">,</span><span class="n">err_flat_2</span><span class="p">)</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Mean&#39;</span><span class="p">):</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">slice_data_orig_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">err_of_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">slice_data_orig_shape</span><span class="o">-</span><span class="n">d_flat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                                     <span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">err_flat_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1">#TYPO err_flat1 --&gt; err_flat_1</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">err_flat_1</span><span class="p">,</span><span class="n">err_flat_2</span><span class="p">)</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span>\
                                            <span class="n">err_of_average</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span>\
                                            <span class="n">err_of_average</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Min&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Max&#39;</span><span class="p">)):</span>
                    <span class="c1"># Finding the appropriate indices</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Min&#39;</span><span class="p">):</span>
                        <span class="n">minmax_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">d_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Max&#39;</span><span class="p">):</span>
                        <span class="n">minmax_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">d_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># Adding back the dimension which was lost in np.argmin</span>
                    <span class="n">minmax_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">minmax_ind</span><span class="p">,</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># Creating an index matrix list which indexes all elements in d_flat but</span>
                    <span class="c1"># in the flattened dimension indexes only one element</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mx_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">submatrix_index</span><span class="p">(</span><span class="n">d_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">index</span><span class="p">))</span>
                    <span class="c1"># Replacing the indexing matrix with the index matrix to the selected elements</span>
                    <span class="n">mx_ind</span><span class="p">[</span><span class="n">summing_coords</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">minmax_ind</span>
                    <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_flat</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">err_flat_1</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">)])</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">err_flat_2</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d_slice</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d_slice</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown summing procedure: &quot;</span><span class="o">+</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">])</span>
                <span class="n">d_slice</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

                <span class="c1"># Doing changes to all coordinates</span>
                <span class="c1"># Saving a copy of the original summing coord structure</span>
                <span class="n">summing_coords_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">summing_coords</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">check_coord</span> <span class="ow">in</span> <span class="n">d_slice</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
                    <span class="c1"># Do nothing for scalar dimension</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Searching for common dimensions between the summing coordinate and the check_coordinate</span>
                    <span class="n">common_dims</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">common_in_dimlist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i_d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)):</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i_d</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">summing_coords_orig</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                            <span class="n">common_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                            <span class="n">common_in_dimlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_d</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># If there are common dimensions:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Min&#39;</span><span class="p">)</span> \
                             <span class="ow">or</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Max&#39;</span><span class="p">)</span> \
                             <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">)):</span>
                            <span class="c1"># In all these cases we must get the data for the selected elements</span>
                            <span class="c1"># Getting coordinate data in the unified dims</span>
                            <span class="n">unified_dims</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">unify_list</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">,</span>
                                                                 <span class="n">summing_coords_orig</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unified_dims</span><span class="p">:</span>
                                <span class="n">ind</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">data</span><span class="p">,</span> <span class="n">data_low</span><span class="p">,</span> <span class="n">data_high</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">original_shape</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">e</span>
                            <span class="c1"># indices of summing dimensions in unified dimension list</span>
                            <span class="n">summing_in_unified</span> <span class="o">=</span> <span class="p">[</span><span class="n">unified_dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">summing_coords_orig</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">]</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="n">data</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">flatten_multidim</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">summing_in_unified</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Sum&#39;</span><span class="p">)</span> \
                                 <span class="ow">or</span> <span class="p">(</span><span class="n">summing_description</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Mean&#39;</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
                                    <span class="c1"># In case of strings it is not possible to take mean of values.</span>
                                    <span class="c1"># Instead using the first string and adding ,...</span>
                                    <span class="c1"># Getting the sub-matrix at the first element in the flattened summing dimension</span>
                                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                                    <span class="n">ind</span><span class="p">[</span><span class="n">common_in_dimlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)])</span>
                                    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;U&#39;</span><span class="p">):</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)])</span>
                                            <span class="n">dtype_new</span> <span class="o">=</span> <span class="s1">&#39;&lt;U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype_new</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,...&#39;</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">shape</span><span class="p">))</span>
                                    <span class="n">data_low</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">data_high</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="n">data_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                    <span class="n">data_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_low</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">summing_in_unified</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Min and Max</span>
                                <span class="c1"># Here mx_ind is an index array list for selecting elements</span>
                                <span class="c1"># from d_flat. Both the number of dimensions of the matrices and the number</span>
                                <span class="c1"># of matrices is d_flat.ndim.</span>
                                <span class="c1"># We could get the coordinate for all data points, flatten it as the data and</span>
                                <span class="c1"># select elements with these matrices, but this would not be effective.</span>
                                <span class="c1"># We keep from these matrices only those dimensions where the check_coordinate</span>
                                <span class="c1"># changes and also keep only those matrices. We will get the coordinate data only</span>
                                <span class="c1"># for the dimensions where check_coord changes and flattened</span>

                                <span class="c1"># Original dimension numbers for the flattened array, the flattened</span>
                                <span class="c1"># dimension is None</span>
                                <span class="n">flattened_dimlist</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">i_d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimension_mapping</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">i_d</span> <span class="o">==</span> <span class="n">summing_coords_orig</span><span class="p">[</span><span class="n">i_sc</span><span class="p">]</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                        <span class="n">flattened_dimlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="p">(</span><span class="n">dimension_mapping</span><span class="p">[</span><span class="n">i_d</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                        <span class="n">flattened_dimlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_d</span><span class="p">)</span>

                                <span class="c1"># Creating an index list for cutting out dimensions from the mx_ind matrices</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">flattened_dimlist</span><span class="p">)</span>
                                <span class="n">mx_ind_shape</span> <span class="o">=</span> <span class="n">mx_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">flattened_dimlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                        <span class="c1"># This is the flattened dimension, must be kept</span>
                                        <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mx_ind_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flattened_dimlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                            <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mx_ind_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                            <span class="k">pass</span>

                                <span class="c1"># Creating the new index matrix list</span>
                                <span class="n">new_mx_ind</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">flattened_dimlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                        <span class="n">new_mx_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flattened_dimlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                            <span class="n">new_mx_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mx_ind</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]))</span>
                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                            <span class="k">pass</span>

                                <span class="c1"># Here data should have only the dimensions where the coordinate</span>
                                <span class="c1"># changes plus the flattened one</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_mx_ind</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="n">data_low</span> <span class="o">=</span> <span class="n">data_low</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_mx_ind</span><span class="p">)]</span>
                                    <span class="n">data_high</span> <span class="o">=</span> <span class="n">data_high</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_mx_ind</span><span class="p">)]</span>
                            <span class="c1"># Putting data into the coordinate description</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
                                <span class="n">check_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">check_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">data_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                                    <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">data_low</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">check_coord</span><span class="o">.</span><span class="n">value_ranges</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">([</span><span class="n">check_coord</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">data_low</span><span class="p">,</span>\
                                                                <span class="n">data_high</span> <span class="o">-</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If not minimum or maximum and equidistant</span>
                            <span class="c1"># Adding the mean of the coordinates to start</span>
                            <span class="c1"># In Sum and Mean this is the mean alonng the dimension</span>
                            <span class="k">for</span> <span class="n">i_dim</span> <span class="ow">in</span> <span class="n">common_in_dimlist</span><span class="p">:</span>
                                <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span> <span class="o">+=</span> <span class="p">(</span><span class="n">original_shape</span><span class="p">[</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i_dim</span><span class="p">]]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> \
                                                     <span class="o">*</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="n">i_dim</span><span class="p">]</span>
                            <span class="c1"># Removing steps related to summed dimensions</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">del_list_elements</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">common_in_dimlist</span><span class="p">)</span>
                        <span class="c1"># For both equidistant and non-equidistant removing summed dimensions from list</span>
                        <span class="n">orig_dimension_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="c1">#UNUSED</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">common_dims</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                                <span class="n">check_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">check_coord</span><span class="o">.</span><span class="n">start</span>
                            <span class="n">check_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Mapping dimensions to the new dimension list even if there is no common dimension</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)):</span>
                        <span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dimension_mapping</span><span class="p">[</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">check_coord</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error in dimension mapping: None dimension&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Regenerate coordinates&#39;</span><span class="p">]):</span>
                <span class="n">d_slice</span><span class="o">.</span><span class="n">regenerate_coordinates</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">summing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad summing description. Use dictionary.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">d_slice</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error. Bad data object after slicing:</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">d_slice</span></div>
    <span class="c1"># End of slice_data</span>

    <span class="k">def</span> <span class="nf">regenerate_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">rel_coord</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">start_coord</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">orig_coord</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">slice_coord</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">cname</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">orig_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">cname</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Start &#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;Start &#39;</span><span class="p">)</span> 
                        <span class="ow">and</span> <span class="p">(</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
                        <span class="ow">and</span> <span class="p">(</span><span class="n">cname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span>
                        <span class="p">)):</span>
                        <span class="n">orig_coord</span> <span class="o">=</span> <span class="n">cname</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Start &#39;</span><span class="p">):</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)]</span>
                        <span class="n">slice_coord</span> <span class="o">=</span> <span class="n">cname</span><span class="p">[</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">start_coord</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">cname</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Rel. &#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;Rel. &#39;</span><span class="p">)</span> 
                        <span class="ow">and</span> <span class="p">(</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
                        <span class="ow">and</span> <span class="p">(</span><span class="n">cname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span>
                        <span class="p">)):</span>
                        <span class="n">orig_coord</span> <span class="o">=</span> <span class="n">cname</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Rel. &#39;</span><span class="p">):</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)]</span>
                        <span class="n">slice_coord</span> <span class="o">=</span> <span class="n">cname</span><span class="p">[</span><span class="n">cname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39; in int(&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">rel_coord</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_name</span> <span class="o">=</span> <span class="s1">&#39;Start &#39;</span><span class="o">+</span><span class="n">orig_coord</span><span class="o">+</span><span class="s1">&#39; in int(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                    <span class="n">rel_name</span> <span class="o">=</span> <span class="s1">&#39;Rel. &#39;</span><span class="o">+</span><span class="n">orig_coord</span><span class="o">+</span><span class="s1">&#39; in int(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cname</span> <span class="o">==</span> <span class="n">start_name</span><span class="p">):</span>
                        <span class="n">start_coord</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cname</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">):</span>
                        <span class="n">rel_coord</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
            <span class="c1"># End while cycle if no suitable coordinate pairs are found</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">start_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rel_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">break</span>
            
            <span class="c1"># Do the changes</span>
            <span class="n">del_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rel_coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">rel_coord</span><span class="p">]</span>
            <span class="n">start_coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">start_coord</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">start_coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                   <span class="n">start_coord_obj</span><span class="o">.</span><span class="n">start</span> <span class="o">+=</span> <span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">start_coord_obj</span><span class="o">.</span><span class="n">values</span> <span class="o">+=</span> <span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">values</span>
                <span class="n">start_coord_obj</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">orig_coord</span>
                <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Interval(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Interval(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;) sample index&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">start_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dr</span> <span class="o">=</span> <span class="n">rel_coord</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">start_coord</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">start_coord</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">dr</span>
                    <span class="n">start_coord_obj</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">orig_coord</span>
                    <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_coord_obj</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Interval(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                    <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Interval(&#39;</span><span class="o">+</span><span class="n">slice_coord</span><span class="o">+</span><span class="s1">&#39;) sample index&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">del_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_coordinate</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                
    <span class="k">def</span> <span class="nf">real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;c&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">d_out</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">)):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Real(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">d_out</span>

    <span class="k">def</span> <span class="nf">imag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot take imageinnary part of real data.&quot;</span><span class="p">)</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">d_out</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">imag</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">)):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Imag(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">d_out</span>

    <span class="k">def</span> <span class="nf">abs_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Abs(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">d_out</span>
    
    <span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Phase can be calculated only from complex data.&quot;</span><span class="p">)</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">error_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">data_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">data_abs</span> <span class="o">&lt;=</span> <span class="n">error_abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">data_abs</span> <span class="o">&gt;</span> <span class="n">error_abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">error</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">error_abs</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">data_abs</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Phase(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">d_out</span>

<div class="viewcode-block" id="DataObject.error_value"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.error_value">[docs]</a>    <span class="k">def</span> <span class="nf">error_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a data object with the error of self in it.</span>
<span class="sd">        options: &#39;High&#39;: Use high error if error is asymmetric</span>
<span class="sd">                 &#39;Low&#39;: Use low error is error is asymmetric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;High&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_options</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_options</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot take error of data if no error is present.&quot;</span><span class="p">)</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of High or Low can be set to True in options.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One one of High or Low can be set to True in options.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d_out</span></div>

<div class="viewcode-block" id="DataObject.apsd"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.apsd">[docs]</a>    <span class="k">def</span> <span class="nf">apsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auto power Spectral Density caclculation for the data object d.</span>
<span class="sd">        Returns a data object with the coordinate replaced by frequency or wavenumber.</span>
<span class="sd">        The power spectrum is calculated in multiple intervals (described by slicing)</span>
<span class="sd">        and the mean and variance will be returned.</span>

<span class="sd">        INPUT:</span>
<span class="sd">            d: A flap.DataObject.</span>
<span class="sd">            coordinate: The name of the coordinate (string) along which to calculate APSD.</span>
<span class="sd">                        This coordinate should change only along one data dimension and should be equidistant.</span>
<span class="sd">                        This and all other cordinates changing along the data dimension of</span>
<span class="sd">                        this coordinate will be removed. A new coordinate with name</span>
<span class="sd">                        Frequency/Wavenumber will be added. The unit will be</span>
<span class="sd">                        derived from the unit of the coordinate (e.g., Hz cm-1, m-1)</span>
<span class="sd">            intervals: Information of processing intervals.</span>
<span class="sd">                       If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                           Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                           coordinate.</span>
<span class="sd">                           Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                           a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                           the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                           interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                           same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                           will be used fromm it to set the intervals.</span>
<span class="sd">                       If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                           description, the selection coordinate is taken the same as</span>
<span class="sd">                           coordinate.</span>
<span class="sd">                       If None, the whole data interval will be used as a single interval.</span>
<span class="sd">            options: Dictionary. (Keys can be abbreviated)</span>
<span class="sd">                &#39;Wavenumber&#39; : True/False. Will use 2*Pi*f for the output coordinate scale, this is useful for</span>
<span class="sd">                               wavenumber calculation.</span>
<span class="sd">                &#39;Resolution&#39;: Output resolution in the unit of the output coordinate.</span>
<span class="sd">                &#39;Range&#39;: Output range in the unit of the output coordinate.</span>
<span class="sd">                &#39;Logarithmic&#39;: True/False. If True will create logarithmic frequency binning.</span>
<span class="sd">                &#39;Interval_n&#39;: Minimum number of intervals to use for the processing. These are identical</span>
<span class="sd">                              length intervals inserted into the input interval list. Default is 8.</span>
<span class="sd">                &#39;Error calculation&#39; : True/False. Calculate or not error. Omitting error calculation</span>
<span class="sd">                                      increases speed. If Interval_n is 1 no error calculation is done.</span>
<span class="sd">                &#39;Trend removal&#39;: Trend removal description (see also _trend_removal()). A list, string or None.</span>
<span class="sd">                             None: Don&#39;t remove trend.</span>
<span class="sd">                             Strings:</span>
<span class="sd">                               &#39;mean&#39;: subtract mean</span>
<span class="sd">                             Lists:</span>
<span class="sd">                               [&#39;poly&#39;, n]: Fit an n order polynomial to the data and subtract.</span>
<span class="sd">                            Trend removal will be applied to each interval separately.</span>
<span class="sd">                 &#39;Hanning&#39;: True/False Use a Hanning window.</span>

<span class="sd">        Return value: The new data object</span>

<span class="sd">        This method is implemented by the _apsd function in spectcral_analysis.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_apsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="DataObject.cpsd"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.cpsd">[docs]</a>    <span class="k">def</span> <span class="nf">cpsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Complex Cross Power Spectrum calculation for the data object self taking d_ref as reference.</span>
<span class="sd">            If self is not set d is used as reference, that is all spectra are calculated within self.</span>
<span class="sd">            Calculates all spectra between all signals in ref and self, but not inside self and ref.</span>
<span class="sd">            self and ref both should have the same equidistant coordinate with equal sampling points.</span>
<span class="sd">            Returns a data object with dimension number self.dim+ref.dim-1. The coordinate is replaced </span>
<span class="sd">            by frequency or wavenumber.</span>
<span class="sd">            The spectrum is calculated in multiple intervals (described by intervals)</span>
<span class="sd">            and the mean and variance will be returned.</span>
<span class="sd">    </span>
<span class="sd">            INPUT:</span>
<span class="sd">                self: A flap.DataObject.</span>
<span class="sd">                ref: Another flap.DataObject</span>
<span class="sd">                coordinate: The name of the coordinate (string) along which to calculate CPSD.</span>
<span class="sd">                            This coordinate should change only along one data dimension and should be equidistant.</span>
<span class="sd">                            This and all other cordinates changing along the data dimension of</span>
<span class="sd">                            this coordinate will be removed. A new coordinate with name</span>
<span class="sd">                            Frequency/Wavenumber will be added. The unit will be</span>
<span class="sd">                            derived from the unit of the coordinate (e.g., Hz cm-1, m-1)</span>
<span class="sd">                intervals: Information of processing intervals.</span>
<span class="sd">                           If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                               Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                               Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                               a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                               the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                               interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                               same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                               will be used fromm it to set the intervals.</span>
<span class="sd">                           If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                               description, the selection coordinate is taken the same as</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                           If None, the whole data interval will be used as a single interval.</span>
<span class="sd">                options: Dictionary. (Keys can be abbreviated)</span>
<span class="sd">                    &#39;Wavenumber&#39; : True/False. Will use 2*Pi*f for the output coordinate scale, this is useful for</span>
<span class="sd">                                   wavenumber calculation.</span>
<span class="sd">                    &#39;Resolution&#39;: Output resolution in the unit of the output coordinate.</span>
<span class="sd">                    &#39;Range&#39;: Output range in the unit of the output coordinate.</span>
<span class="sd">                    &#39;Logarithmic&#39;: True/False. If True will create logarithmic frequency binning.</span>
<span class="sd">                    &#39;Interval_n&#39;: Minimum number of intervals to use for the processing. These are identical</span>
<span class="sd">                                  length intervals inserted into the input interval list. Default is 8.</span>
<span class="sd">                    &#39;Error calculation&#39; : True/False. Calculate or not error. Omitting error calculation</span>
<span class="sd">                                          increases speed. If Interval_n is 1 no error calculation is done.</span>
<span class="sd">                    &#39;Trend removal&#39;: Trend removal description (see also _trend_removal()). A list, string or None.</span>
<span class="sd">                                 None: Don&#39;t remove trend.</span>
<span class="sd">                                 Strings:</span>
<span class="sd">                                   &#39;mean&#39;: subtract mean</span>
<span class="sd">                                 Lists:</span>
<span class="sd">                                   [&#39;poly&#39;, n]: Fit an n order polynomial to the data and subtract.</span>
<span class="sd">                                Trend removal will be applied to each interval separately.</span>
<span class="sd">                    &#39;Hanning&#39;: True/False Use a Hanning window.</span>
<span class="sd">                    &#39;Normalize&#39;: Calculate coherency instead of crosspower</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_cpsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="DataObject.ccf"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.ccf">[docs]</a>    <span class="k">def</span> <span class="nf">ccf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            N dimensional Cross Correlation Function or covariance calculation for the data object self taking d_ref </span>
<span class="sd">            as reference. If ref is not set self is used as reference, that is all CCFs are calculated </span>
<span class="sd">            within self. Calculates all CCF between all signals in ref and sel, but not inside self and ref.</span>
<span class="sd">            Correlation is calculated along the coordinate(s) listed in coordinate which should be</span>
<span class="sd">            identical for the to input data objects.</span>
<span class="sd">            Returns a data object with dimension number self.dim+ref.dim-len(coordinate). </span>
<span class="sd">            The coordinates are replaced by coordinate+&#39; lag&#39;.</span>
<span class="sd">            The CCF is calculated in multiple intervals (described by intervals)</span>
<span class="sd">            and the mean and variance will be returned.</span>
<span class="sd">    </span>
<span class="sd">            INPUT:</span>
<span class="sd">                self: A flap.DataObject.</span>
<span class="sd">                ref: Another flap.DataObject</span>
<span class="sd">                coordinate: The name of the coordinate (string) along which to calculate CCF or a list of names.</span>
<span class="sd">                            Each coordinate should change only along one data dimension and should be equidistant.</span>
<span class="sd">                            This and all other cordinates changing along the data dimension of</span>
<span class="sd">                            these coordinates will be removed. New coordinates with name+&#39; lag&#39; will be added. </span>
<span class="sd">                intervals: Information of processing intervals.</span>
<span class="sd">                           If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                               Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                               Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                               a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                               the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                               interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                               same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                               will be used fromm it to set the intervals.</span>
<span class="sd">                           If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                               description, the selection coordinate is taken the same as</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                           If None, the whole data interval will be used as a single interval.</span>
<span class="sd">                options: Dictionary. (Keys can be abbreviated)</span>
<span class="sd">                    &#39;Resolution&#39;: Output resolution for each coordinate. (list of values or single value)</span>
<span class="sd">                    &#39;Range&#39;: Output ranges for each coordinate. (List or list of lists)</span>
<span class="sd">                    &#39;Interval_n&#39;: Minimum number of intervals to use for the processing. These are identical</span>
<span class="sd">                                  length intervals inserted into the input interval list. Default is 8.</span>
<span class="sd">                    &#39;Error calculation&#39; : True/False. Calculate or not error. Omitting error calculation</span>
<span class="sd">                                          increases speed. If Interval_n is 1 no error calculation is done.</span>
<span class="sd">                    &#39;Trend removal&#39;: Trend removal description (see also _trend_removal()). A list, string or None.</span>
<span class="sd">                                 None: Don&#39;t remove trend.</span>
<span class="sd">                                 Strings:</span>
<span class="sd">                                   &#39;mean&#39;: subtract mean</span>
<span class="sd">                                 Lists:</span>
<span class="sd">                                   [&#39;poly&#39;, n]: Fit an n order polynomial to the data and subtract.</span>
<span class="sd">                                Trend removal will be applied to each interval separately.</span>
<span class="sd">                                At present trend removal can be applied to 1D CCF only.</span>
<span class="sd">                    &#39;Hanning&#39;: True/False Use a Hanning window.</span>
<span class="sd">                    &#39;Normalize&#39;: Normalize with autocorrelations, that is calculate correlation instead of covariance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_ccf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="DataObject.detrend"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.detrend">[docs]</a>    <span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Trend removal.</span>
<span class="sd">            INPUT:</span>
<span class="sd">                coordinate: The x coordinate for the trend removal.</span>
<span class="sd">                intervals: Information of processing intervals.</span>
<span class="sd">                           If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                               Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                               Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                               a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                               the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                               interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                               same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                               will be used fromm it to set the intervals.</span>
<span class="sd">                           If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                               description, the selection coordinate is taken the same as</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                           If None, the whole data interval will be used as a single interval.</span>
<span class="sd">                options:</span>
<span class="sd">                  &#39;Trend removal&#39;: Trend removal description (see also _trend_removal()). A list, string or None.</span>
<span class="sd">                    None: Don&#39;t remove trend.</span>
<span class="sd">                    Strings:</span>
<span class="sd">                      &#39;Mean&#39;: subtract mean</span>
<span class="sd">                    Lists:</span>
<span class="sd">                      [&#39;Poly&#39;, n]: Fit an n order polynomial to the data and subtract.</span>
<span class="sd">                            Trend removal will be applied to each interval defined by slicing</span>
<span class="sd">                            separately.</span>
<span class="sd">            Return value: The data object with the trend removed data.</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot detrend without data.&quot;</span><span class="p">)</span>
        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Trend removal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Poly&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_options</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_options</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                             <span class="n">data_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
                                             <span class="n">section</span><span class="o">=</span><span class="s1">&#39;Trend removal&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">c_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
                <span class="n">_coordinate</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No coordinate is given for detrend and no Time coordinate found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">_coordinate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trend removal is possible only along coordinates changing along one dimension.&quot;</span><span class="p">)</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Trend removal&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>    
            <span class="n">calc_int</span><span class="p">,</span> <span class="n">calc_int_ind</span><span class="p">,</span> <span class="n">sel_int</span><span class="p">,</span> <span class="n">sel_int_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc_interval_limits</span><span class="p">(</span><span class="n">_coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">int_start_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">int_end_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">int_start</span> <span class="o">=</span> <span class="n">sel_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">int_end</span> <span class="o">=</span> <span class="n">sel_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                                    <span class="c1">#UNUSED</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">_coordinate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="n">_coordinate</span>                                        <span class="c1">#UNUSED</span>
            <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="n">coord_obj</span>


        <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_int</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">int_start</span><span class="p">)):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">],</span><span class="n">int_end_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="n">_trend_removal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)],</span>
                               <span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">trend</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">index</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">],</span><span class="n">int_end_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">])</span>
                    <span class="n">coord_data</span> <span class="o">=</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">_trend_removal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)],</span>
                               <span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">trend</span><span class="p">,</span>
                               <span class="n">x</span> <span class="o">=</span> <span class="n">coord_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="DataObject.filter_data"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.filter_data">[docs]</a>    <span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 1D Data filter.</span>
<span class="sd">            INPUT:</span>
<span class="sd">                coordinate: The x coordinate for the trend removal.</span>
<span class="sd">                intervals: Information of processing intervals.</span>
<span class="sd">                           If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                               Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                               Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                               a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                               the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                               interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                               same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                               will be used fromm it to set the intervals.</span>
<span class="sd">                           If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                               description, the selection coordinate is taken the same as</span>
<span class="sd">                               coordinate.</span>
<span class="sd">                           If None, the whole data interval will be used as a single interval.</span>
<span class="sd">                options:</span>
<span class="sd">                    &#39;Type&#39; :</span>
<span class="sd">                        None: Do nothing.</span>
<span class="sd">                        &#39;Int&#39;: Single term IIF filter, like RC integrator. </span>
<span class="sd">                        &#39;Diff&#39;: Single term IIF filter, like RC differentiator.</span>
<span class="sd">                        &#39;Bandpass&#39;, &#39;Lowpass&#39;, &#39;Highpass&#39;: Filters designed by scipy.signal.iirdesign.</span>
<span class="sd">                                                           The filter type is in &#39;Design&#39;</span>
<span class="sd">                                   Bandpass: f_low - f_high</span>
<span class="sd">                                   Lowpass: - f_high</span>
<span class="sd">                                   Highpass: - f_low</span>
<span class="sd">                    &#39;Design&#39;: The design type of the bandpass, lowpass or highpass filter. </span>
<span class="sd">                              (&#39;Elliptic&#39;, &#39;Butterworth, &#39;Chebyshev I&#39;, &#39;Chebyshev II&#39;, &#39;Bessel&#39;) </span>
<span class="sd">                              The numpy.iirdesign function is used for generating the filter.  </span>
<span class="sd">                              Setting inconsistent parameters can cause strange results. E.g. too high attenuation</span>
<span class="sd">                              at too low frequency relative to the smapling frequency can be a problem.</span>
<span class="sd">                    &#39;f_low&#39;, &#39;f_high&#39;: Cut on/off frequencies. (Middle between passband and stopband edge.)</span>
<span class="sd">                    &#39;Steepness&#39;: Difference between passband and stopband edge frequencies as a fraction </span>
<span class="sd">                                 of the middle frequency.</span>
<span class="sd">                     &#39;Loss&#39;: The maximum loss in the passband in dB</span>
<span class="sd">                     &#39;Attenuation&#39;: The minimum attenuation in the stopband dB</span>
<span class="sd">                    &#39;Tau&#39;: time constant for integrator/differentiator (in units of the coordinate)</span>
<span class="sd">                    &#39;Power&#39;: Calculate square of the signal after filtering. (boolean)</span>
<span class="sd">                    &#39;Inttime&#39;: Integration time after power calculation. (in units of oordinate)</span>
<span class="sd">            Return value: The data object with the filtered data.</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot filter without data.&quot;</span><span class="p">)</span>
        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Type&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Tau&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Design&#39;</span><span class="p">:</span><span class="s1">&#39;Elliptic&#39;</span><span class="p">,</span> <span class="s1">&#39;f_low&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;f_high&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;Steepness&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;Power&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Inttime&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Loss&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Attenuation&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_options</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_options</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                             <span class="n">data_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
                                             <span class="n">section</span><span class="o">=</span><span class="s1">&#39;Filter data&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">c_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
                <span class="n">_coordinate</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No coordinate is given for filter and no Time coordinate found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">_coordinate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filtering is possible only along coordinates changing along one dimension.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">coord_obj</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filtering is possible only along equidistant coordinates.&quot;</span><span class="p">)</span>
        <span class="n">filter_type</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Int&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Diff&#39;</span><span class="p">)):</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Tau&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing time constant (Tau) option for filtering.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Bandpass&#39;</span><span class="p">):</span>
            <span class="n">f_low</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;f_low&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing f_low parameter for bandpass filter.&quot;</span><span class="p">)</span>
            <span class="n">f_high</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;f_high&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f_high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing f_high parameter for bandpass filter.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Lowpass&#39;</span><span class="p">):</span>
            <span class="n">f_high</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;f_high&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f_high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing f_high parameter for lowpass filter.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Highpass&#39;</span><span class="p">):</span>
            <span class="n">f_low</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;f_low&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing f_low parameter for highpass filter.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid filter type.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Design&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Elliptic&#39;</span><span class="p">):</span>
            <span class="n">design</span> <span class="o">=</span> <span class="s1">&#39;ellip&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Design&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Butterworth&#39;</span><span class="p">):</span>
            <span class="n">design</span> <span class="o">=</span> <span class="s1">&#39;butter&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Design&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Chebyshev I&#39;</span><span class="p">):</span>
            <span class="n">design</span> <span class="o">=</span> <span class="s1">&#39;cheby1&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Design&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Chebyshev II&#39;</span><span class="p">):</span>
            <span class="n">design</span> <span class="o">=</span> <span class="s1">&#39;cheby2&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Design&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bessel&#39;</span><span class="p">):</span>
            <span class="n">design</span> <span class="o">=</span> <span class="s1">&#39;bessel&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid filter design.&quot;</span><span class="p">)</span>
    
        <span class="n">loss</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Loss&#39;</span><span class="p">]</span>
        <span class="n">attenuation</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Attenuation&#39;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>    
            <span class="n">calc_int</span><span class="p">,</span> <span class="n">calc_int_ind</span><span class="p">,</span> <span class="n">sel_int</span><span class="p">,</span> <span class="n">sel_int_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc_interval_limits</span><span class="p">(</span><span class="n">_coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">int_start_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">int_end_ind</span> <span class="o">=</span> <span class="n">sel_int_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">int_start</span> <span class="o">=</span> <span class="n">sel_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">int_end</span> <span class="o">=</span> <span class="n">sel_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                                    <span class="c1">#UNUSED</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">sel_coordinate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel_coordinate</span> <span class="o">=</span> <span class="n">_coordinate</span>
            <span class="n">sel_coord_obj</span> <span class="o">=</span> <span class="n">coord_obj</span>


        <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_int</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">int_start</span><span class="p">)):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">],</span><span class="n">int_end_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Int&#39;</span><span class="p">):</span>
                <span class="n">tau_norm</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">)])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ind_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">ind_0</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_0</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> 
                                                <span class="n">a</span><span class="p">,</span> 
                                                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> 
                                                <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">zi</span><span class="o">=</span><span class="n">zi</span>
                                                <span class="p">)</span>   

            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Diff&#39;</span><span class="p">):</span>   
                <span class="n">tau_norm</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">)])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ind_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">ind_0</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_0</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">zi</span>
                <span class="n">dd</span><span class="p">,</span><span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> 
                                       <span class="n">a</span><span class="p">,</span> 
                                       <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> 
                                       <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">zi</span><span class="o">=</span><span class="n">zi</span><span class="p">)</span>   
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span>  <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">dd</span>              
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Lowpass&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">steep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Steepness&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid steepness option.&quot;</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_high</span> <span class="o">-</span> <span class="n">f_high</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_high</span> <span class="o">+</span> <span class="n">f_high</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
                <span class="n">gpass</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">gstop</span> <span class="o">=</span> <span class="mi">40</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">iirdesign</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span><span class="n">ws</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">attenuation</span><span class="p">,</span><span class="n">ftype</span><span class="o">=</span><span class="n">design</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">start_data</span><span class="p">)</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">start_data</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter_zi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">zi_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">start_data</span><span class="o">.</span><span class="n">ndim</span>
                <span class="n">zi_shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">zi_shape</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">zi</span> <span class="o">*</span> <span class="n">start_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zi</span><span class="o">=</span><span class="n">zi</span><span class="p">)</span>   
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Highpass&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">steep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Steepness&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid steepness option.&quot;</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_low</span> <span class="o">+</span> <span class="n">f_low</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span> 
                <span class="n">ws</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_low</span> <span class="o">-</span> <span class="n">f_low</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
                <span class="n">gpass</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">gstop</span> <span class="o">=</span> <span class="mi">40</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">iirdesign</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span><span class="n">ws</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">attenuation</span><span class="p">,</span><span class="n">ftype</span><span class="o">=</span><span class="n">design</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>
                <span class="c1"># preparing start of filtered signal, so as it starts the the steady part of the transfer function. </span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">start_data</span><span class="p">)</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">start_data</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter_zi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">zi_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">start_data</span><span class="o">.</span><span class="n">ndim</span>
                <span class="n">zi_shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">zi_shape</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">zi</span> <span class="o">*</span> <span class="n">start_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zi</span><span class="o">=</span><span class="n">zi</span><span class="p">)</span>   
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_type</span> <span class="o">==</span> <span class="s1">&#39;Bandpass&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">steep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Steepness&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid steepness option.&quot;</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">wp</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f_low</span> <span class="o">+</span> <span class="n">f_low</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">f_high</span> <span class="o">-</span> <span class="n">f_high</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">]</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f_low</span> <span class="o">-</span> <span class="n">f_low</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">f_high</span> <span class="o">+</span> <span class="n">f_high</span> <span class="o">*</span> <span class="n">steep</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">]</span>
                <span class="n">gpass</span> <span class="o">=</span> <span class="mi">3</span>                                                       <span class="c1">#UNUSED</span>
                <span class="n">gstop</span> <span class="o">=</span> <span class="mi">40</span>                                                      <span class="c1">#UNUSED</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">iirdesign</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span><span class="n">ws</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">attenuation</span><span class="p">,</span><span class="n">ftype</span><span class="o">=</span><span class="n">design</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">start_data</span><span class="p">)</span>
                <span class="n">start_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">start_data</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter_zi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">zi_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">start_data</span><span class="o">.</span><span class="n">ndim</span>
                <span class="n">zi_shape</span><span class="p">[</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">zi_shape</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">zi</span> <span class="o">*</span> <span class="n">start_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zi</span><span class="o">=</span><span class="n">zi</span><span class="p">)</span>   
            <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Power&#39;</span><span class="p">]):</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Inttime&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">inttime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;Inttime&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid Inttime value.&quot;</span><span class="p">)</span>
                <span class="n">tau_norm</span> <span class="o">=</span> <span class="n">inttime</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">)])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau_norm</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ind_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">ind_0</span><span class="p">[</span><span class="n">sel_coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_start_ind</span><span class="p">[</span><span class="n">i_int</span><span class="p">]</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind_0</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">zo</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> 
                                                <span class="n">a</span><span class="p">,</span> 
                                                <span class="n">d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> 
                                                <span class="n">axis</span><span class="o">=</span><span class="n">coord_obj</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">zi</span><span class="o">=</span><span class="n">zi</span>
                                                <span class="p">)</span>   
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="DataObject.save"><a class="viewcode-back" href="../../data_object.html#flap.data_object.DataObject.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data object to a binary file using pickle.</span>
<span class="sd">        Use load to read the object.</span>
<span class="sd">        Filename: The name of the output file</span>
<span class="sd">        protocol: The pickle protocol to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot open file &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Error encoding data object.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot close file &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Addition for DataObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects with different units.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects with different data names.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects with different shapes.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>                    
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
                                                   
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">DataObject</span><span class="p">(</span><span class="n">data_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="n">d1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">error</span><span class="o">=</span><span class="n">err</span><span class="p">,</span>
                               <span class="n">data_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">coord</span> <span class="o">!=</span> <span class="n">c1</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">exp_id</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">d1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add strings.&quot;</span><span class="p">)</span>
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">d1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid data type for addition with flap.DataObject&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d_out</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Subtraction for DataObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subtract data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subtract data objects with different units.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subtract data objects with different data names.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subtract data objects with different shapes.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>                    
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)]</span>
                                                   
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">DataObject</span><span class="p">(</span><span class="n">data_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">d1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">error</span><span class="o">=</span><span class="n">err</span><span class="p">,</span>
                               <span class="n">data_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">coord</span> <span class="o">!=</span> <span class="n">c1</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">exp_id</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">d1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add strings.&quot;</span><span class="p">)</span>
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">d1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid data type for subtaction from flap.DataObject&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d_out</span>

    <span class="k">def</span> <span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
             <span class="n">d</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span><span class="o">.</span><span class="n">data</span>
             <span class="k">return</span> <span class="n">d</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Multiplication for DataObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot multiply data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot multiply data objects with different shapes.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">err1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err2</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">error</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">err2</span> <span class="o">**</span> <span class="mi">2</span> 
                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">err2</span> <span class="o">**</span> <span class="mi">2</span>
                              <span class="o">+</span> <span class="n">d1</span><span class="o">.</span><span class="n">data</span> <span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">err1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">new_unit</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Unit</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">new_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;^2&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_unit</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">d1</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span><span class="p">):</span>
                <span class="n">new_unit</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">+</span><span class="s1">&#39;^2&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_unit</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">d1</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span>
                
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">DataObject</span><span class="p">(</span><span class="n">data_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">d1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">error</span><span class="o">=</span><span class="n">err</span><span class="p">,</span>
                               <span class="n">data_unit</span><span class="o">=</span><span class="n">new_unit</span>
                               <span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">get_coordinate_object</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">coord</span> <span class="o">!=</span> <span class="n">c1</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">exp_id</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="n">d1</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">d1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot multiply data objects without data.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot multiply strings.&quot;</span><span class="p">)</span>
            <span class="n">d_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">d_out</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">d1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d_out</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">d1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d_out</span><span class="o">.</span><span class="n">error</span> <span class="o">*=</span> <span class="n">d1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid data type for multiplication with flap.DataObject&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d_out</span>
             
    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">e</span></div>
             
<span class="c1">########## END of class DataObject            </span>
            
<div class="viewcode-block" id="FlapStorage"><a class="viewcode-back" href="../../data_object.html#flap.data_object.FlapStorage">[docs]</a><span class="k">class</span> <span class="nc">FlapStorage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; This class is for data and data source information storage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># List of data sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of get_data function objects for each data source.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_data_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of functions for adding coordinates to a data object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_coordinate_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The data objects. This is a dictionary, the keys are the data object names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="sd">&quot;&quot;&quot; The methods below are interfaces for the private variables of this class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_sources</span>

    <span class="k">def</span> <span class="nf">add_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_source</span><span class="p">,</span><span class="n">get_data_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_coord_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_data_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_data_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_coordinate_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_coord_func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_data_functions</span>

    <span class="k">def</span> <span class="nf">add_coord_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_coordinate_functions</span>

    <span class="k">def</span> <span class="nf">data_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span>

    <span class="k">def</span> <span class="nf">add_data_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_exp_id:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">delete_data_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_exp_id:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="n">del_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">_name</span><span class="p">)):</span>
                <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">del_list</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

<div class="viewcode-block" id="FlapStorage.find_data_objects"><a class="viewcode-back" href="../../data_object.html#flap.data_object.FlapStorage.find_data_objects">[docs]</a>    <span class="k">def</span> <span class="nf">find_data_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot; </span>
<span class="sd">        Find data objects in flap storage.</span>
<span class="sd">        </span>
<span class="sd">        Returns name list, exp_ID list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_exp_id:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="n">nlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">explist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">_name</span><span class="p">)):</span>
                <span class="n">n_split</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_exp_id:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">explist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">explist</span></div>
                

    <span class="k">def</span> <span class="nf">get_data_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Object name should be a string.&quot;</span><span class="p">)</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_exp_id:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">_name</span><span class="p">)):</span>
                    <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Data object &quot;</span> <span class="o">+</span> <span class="n">name</span>
                               <span class="o">+</span> <span class="s2">&quot;(exp_id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) does not exists.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Multiple data objects found for name &quot;</span>
                               <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(exp_id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;).&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">nlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">get_data_object_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_exp_id:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">_name</span><span class="p">)):</span>
                    <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Data object &quot;</span> <span class="o">+</span> <span class="n">name</span>
                               <span class="o">+</span> <span class="s2">&quot;(exp_id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) does not exists.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Multiple data objects found for name &quot;</span>
                               <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(exp_id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_objects</span><span class="p">[</span><span class="n">nlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">list_data_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">names</span><span class="p">,</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">find_data_objects</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        
        <span class="n">d_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_names</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_data_object</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i_names</span><span class="p">],</span> <span class="n">exp_id</span><span class="o">=</span><span class="n">exps</span><span class="p">[</span><span class="n">i_names</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">d_list</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">exps</span></div>


<span class="c1"># This is the instance of the storage class</span>
<span class="c1"># it will be created only if it does not exists.</span>
<span class="k">global</span> <span class="n">flap_storage</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">flap_storage</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
<span class="c1">#        if (VERBOSE):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INIT flap storage&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">flap_storage</span> <span class="o">=</span> <span class="n">FlapStorage</span><span class="p">()</span>


<span class="c1"># The functions below are the flap interface</span>
<div class="viewcode-block" id="list_data_sources"><a class="viewcode-back" href="../../data_object.html#flap.data_object.list_data_sources">[docs]</a><span class="k">def</span> <span class="nf">list_data_sources</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Return a list of registered data source names as a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">return</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">data_sources</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_data_function"><a class="viewcode-back" href="../../data_object.html#flap.data_object.get_data_function">[docs]</a><span class="k">def</span> <span class="nf">get_data_function</span><span class="p">(</span><span class="n">data_source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the get data function object for a given data source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">data_sources</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data source &quot;</span><span class="o">+</span><span class="n">data_source</span><span class="o">+</span><span class="s2">&quot; is unknown.&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">get_data_functions</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_addcoord_function"><a class="viewcode-back" href="../../data_object.html#flap.data_object.get_addcoord_function">[docs]</a><span class="k">def</span> <span class="nf">get_addcoord_function</span><span class="p">(</span><span class="n">data_source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the add_coord function object for a given data source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">data_sources</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data source &quot;</span> <span class="o">+</span> <span class="n">data_source</span> <span class="o">+</span> <span class="s2">&quot; is unknown.&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">add_coord_functions</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="register_data_source"><a class="viewcode-back" href="../../data_object.html#flap.data_object.register_data_source">[docs]</a><span class="k">def</span> <span class="nf">register_data_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">get_data_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_coord_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a new data source name and the associated functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flap_storage</span><span class="o">.</span><span class="n">data_sources</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">flap_storage</span><span class="o">.</span><span class="n">add_data_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                     <span class="n">get_data_func</span><span class="o">=</span><span class="n">get_data_func</span><span class="p">,</span>
                                     <span class="n">add_coord_func</span><span class="o">=</span><span class="n">add_coord_func</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="add_data_object"><a class="viewcode-back" href="../../data_object.html#flap.data_object.add_data_object">[docs]</a><span class="k">def</span> <span class="nf">add_data_object</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">object_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Add a data object to the flap storage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="n">flap_storage</span><span class="o">.</span><span class="n">add_data_object</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">object_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_data_object"><a class="viewcode-back" href="../../data_object.html#flap.data_object.delete_data_object">[docs]</a><span class="k">def</span> <span class="nf">delete_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Delete data object(s) from the flap storage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">_object_name</span> <span class="o">=</span> <span class="n">object_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_object_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">_exp_id</span> <span class="o">=</span> <span class="n">exp_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_exp_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_id</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">_object_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_object_name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_exp_id</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lenght of object_name and exp_id list should be identical in delete_data_object()&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_object_name</span><span class="p">,</span><span class="n">_exp_id</span><span class="p">):</span>    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flap_storage</span><span class="o">.</span><span class="n">delete_data_object</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="find_data_objects"><a class="viewcode-back" href="../../data_object.html#flap.data_object.find_data_objects">[docs]</a><span class="k">def</span> <span class="nf">find_data_objects</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find data objects in flap storage.</span>
<span class="sd">    </span>
<span class="sd">    Returns list of names, list of expID.s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span><span class="p">,</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">find_data_objects</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">,</span> <span class="n">exps</span></div>


<div class="viewcode-block" id="get_data_object"><a class="viewcode-back" href="../../data_object.html#flap.data_object.get_data_object">[docs]</a><span class="k">def</span> <span class="nf">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Return a data object from the flap storage</span>
<span class="sd">         A coppy is returned not the object in the storage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="get_data_object_ref"><a class="viewcode-back" href="../../data_object.html#flap.data_object.get_data_object_ref">[docs]</a><span class="k">def</span> <span class="nf">get_data_object_ref</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Return a data object reference from the flap storage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">flap_storage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">get_data_object_ref</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="list_data_objects"><a class="viewcode-back" href="../../data_object.html#flap.data_object.list_data_objects">[docs]</a><span class="k">def</span> <span class="nf">list_data_objects</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">screen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Prepare a printout of data objects is flap storage or the listed data objects.</span>
<span class="sd">        name: name (with wildcards) or list of data objects</span>
<span class="sd">        exp_id: exp id for name</span>
<span class="sd">        screen: (bool) If True print to screen</span>
<span class="sd">        </span>
<span class="sd">        Return value: The text</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataObject</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">d_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">d_list</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataObject</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;List of flap.DataObjects is expected.&quot;</span><span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{:d}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_list</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">flap_storage</span><span class="o">.</span><span class="n">list_data_objects</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i_names</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_list</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">dtit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtit</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data_title</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">exp_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">expid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expid</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">exp_id</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data_source</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="n">names</span><span class="p">[</span><span class="n">i_names</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(data_source:&quot;&#39;</span><span class="o">+</span><span class="n">ds</span><span class="o">+</span><span class="s1">&#39;&quot; exp_id:&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;) data_title:&quot;&#39;</span> <span class="o">+</span> <span class="n">dtit</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; shape:[&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_shape</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; [no data]&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;[no error]&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;[error asymm.]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;[error symm.]&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">data_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">data_unit</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">data_unit</span><span class="o">.</span><span class="n">unit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Data name:&quot;&#39;</span><span class="o">+</span><span class="n">data_name</span><span class="o">+</span><span class="s1">&#39;&quot;, unit:&quot;&#39;</span><span class="o">+</span><span class="n">data_unit</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Coords:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">c_names</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_names</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;(Dims:&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;None in dim. list!&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)):</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;, Shape:[&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)):</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;]) [&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;&lt;Equ.&gt;&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">range_symmetric</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;&lt;R. symm.&gt;&#39;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;] &#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span><span class="s1">&#39;[Ranges set] &#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">equidistant</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Start: </span><span class="si">{:10.3E}</span><span class="s1">, Steps: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">step</span><span class="p">)):</span>
                   <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:10.3E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="n">i_step</span><span class="p">])</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">i_step</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">step</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                       <span class="n">s</span> <span class="o">+=</span><span class="s2">&quot;, &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">dimension_list</span><span class="p">:</span>
                        <span class="n">ind</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span>
                <span class="n">c_data</span><span class="p">,</span> <span class="n">c_range_l</span><span class="p">,</span> <span class="n">c_range_h</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">dtype</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">no_max</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="s2">&quot;</span><span class="si">{:10.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">c_data</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">no_max</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">c_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="n">no_max</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Val:&#39;</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">size</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">c_data</span><span class="p">)):</span>
                                <span class="n">s</span> <span class="o">+=</span> <span class="n">c_data</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">+=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">dt</span> <span class="ow">is</span> <span class="n">Decimal</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dt</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)):</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{:10.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;...&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Val. range: &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:10.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">c_data</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span>\
                         <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:10.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">c_data</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">screen</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="get_data"><a class="viewcode-back" href="../../data_object.html#flap.data_object.get_data">[docs]</a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span>
             <span class="n">exp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">no_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">object_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is a general data read interface. It will call the specific data read interface</span>
<span class="sd">        for the registered data sources.</span>
<span class="sd">        data_source: The name of the data source (string)</span>
<span class="sd">        exp_id: Experiment ID</span>
<span class="sd">        coordinates: Two options:</span>
<span class="sd">                     1. List of flap.Coordinate objects. Thes can precisely describe which part of the data to read</span>
<span class="sd">                     2. Dictionary. Each key is a coordinate name, the values can be </span>
<span class="sd">                         - A list of two elements (describes a range in the coordinate). </span>
<span class="sd">                         - A single element. Will be converted into a list with two identical elements</span>
<span class="sd">                        The dictionary will be converted to a list of flap.Coordinate objects and</span>
<span class="sd">                        the data source modulee will get that. </span>
<span class="sd">        name: The name of the data to get</span>
<span class="sd">        no_data: Set to True to check data but do not read</span>
<span class="sd">        options: Module specific options</span>
<span class="sd">        object_name: the name of the data object in flap storage where data will be placed.</span>
<span class="sd">        </span>
<span class="sd">        Return value is the data object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data name is not given.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">get_data_function</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No get_data function is associated with data source &quot;</span> <span class="o">+</span> <span class="n">data_source</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="n">c_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="n">c_name</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coordinates keyword argument must be either a list of flap.Coordinates a value or a list of two values.&quot;</span><span class="p">)</span>
                <span class="n">_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span><span class="n">c_range</span><span class="o">=</span><span class="n">coordinates</span><span class="p">[</span><span class="n">c_name</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flap</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span><span class="n">c_range</span><span class="o">=</span><span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="n">c_name</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;data_source&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()):</span>
            <span class="n">data_source_local</span><span class="o">=</span><span class="n">data_source</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_source_local</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1"># Calling the data module get_data function</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">no_data</span><span class="o">=</span><span class="n">no_data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> 
              <span class="n">coordinates</span><span class="o">=</span><span class="n">_coordinates</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="n">data_source_local</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Checking whethet the error os due to unknown data_source argument</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;unexpected keyword argument &#39;data_source&#39;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># If nat raise the error</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="c1"># Trying without data_source as this was not part of earlier version</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">no_data</span><span class="o">=</span><span class="n">no_data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">_coordinates</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The get_data function of data_source &#39;&quot;</span><span class="o">+</span><span class="n">data_source</span><span class="o">+</span><span class="s2">&quot;&#39; does not support the data_source keyword. Please upgrade.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataObject</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data receiveid.&quot;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
        
    <span class="k">if</span> <span class="p">((</span><span class="n">object_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="n">add_data_object</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">object_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="add_coordinate"><a class="viewcode-back" href="../../data_object.html#flap.data_object.add_coordinate">[docs]</a><span class="k">def</span> <span class="nf">add_coordinate</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span>
                   <span class="n">coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                   <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is the function to add coordinates to a data object in flap storage.</span>
<span class="sd">        This function is an interface to the add_coordinate method of flap.DataObject</span>

<span class="sd">        INPUT:</span>
<span class="sd">            object_name, exp_ID: These identify the data object in the storage</span>
<span class="sd">            coordinates: List of new coordinates (string list)</span>
<span class="sd">            output_name: The name of the new data object in the storage. If None</span>
<span class="sd">                         the input will be overwritten</span>
<span class="sd">            options: Dictionary</span>
<span class="sd">                &#39;exp_ID&#39;: Use this exp_id for calculating coordinates instead of the one</span>
<span class="sd">                          in the data object</span>
<span class="sd">                &#39;data_source&#39; : Use this data source instead of the one in the</span>
<span class="sd">                                data object.</span>
<span class="sd">                Other elements of options are passed over to flap.add_coordinate()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exp_id_new</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;exp_ID&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;exp_ID&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">exp_id_new</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data_source_new</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">data_source_new</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">add_coordinate</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                         <span class="n">data_source</span><span class="o">=</span><span class="n">data_source_new</span><span class="p">,</span>
                         <span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id_new</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_output_name</span> <span class="o">=</span> <span class="n">object_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_output_name</span> <span class="o">=</span> <span class="n">output_name</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">add_data_object</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">_output_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="plot"><a class="viewcode-back" href="../../data_object.html#flap.data_object.plot">[docs]</a><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slicing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slicing_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot function for an object in flap storage. This is a wrapper for DataObject.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                      <span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">,</span> 
                      <span class="n">slicing_options</span><span class="o">=</span><span class="n">slicing_options</span><span class="p">,</span>
                      <span class="n">summing</span><span class="o">=</span><span class="n">summing</span><span class="p">,</span> 
                      <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                      <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
                      <span class="n">plot_options</span><span class="o">=</span><span class="n">plot_options</span><span class="p">,</span>
                      <span class="n">plot_id</span><span class="o">=</span><span class="n">plot_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="slice_data"><a class="viewcode-back" href="../../data_object.html#flap.data_object.slice_data">[docs]</a><span class="k">def</span> <span class="nf">slice_data</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slicing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">summing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    slice function for an object in flap storage. This is a wrapper for DataObject.slicec_data()</span>
<span class="sd">    If output name is set the sliced object will be written back to the flap storage under this name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">slice_data</span><span class="p">(</span><span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">,</span><span class="n">summing</span><span class="o">=</span><span class="n">summing</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="apsd"><a class="viewcode-back" href="../../data_object.html#flap.data_object.apsd">[docs]</a><span class="k">def</span> <span class="nf">apsd</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auto Power Spetctrum for an object in flap storage. This is a wrapper for DataObject.apsd()</span>
<span class="sd">    If output name is set the APSD object will be written back to the flap storage under this name.</span>
<span class="sd">    If not set the APSD object will be written back with its original name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">apsd</span><span class="p">(</span><span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="cpsd"><a class="viewcode-back" href="../../data_object.html#flap.data_object.cpsd">[docs]</a><span class="k">def</span> <span class="nf">cpsd</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cross Power Spectrum between two objects in flap storage. (ref can also be a data object.) </span>
<span class="sd">    This is a wrapper for DataObject.cpsd()</span>
<span class="sd">    If output name is set the CPSD object will be written back to the flap storage under this name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d_ref</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_ref</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid reference data structure. Should be string or flap.DataObject.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_ref</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">cpsd</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">d_ref</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="ccf"><a class="viewcode-back" href="../../data_object.html#flap.data_object.ccf">[docs]</a><span class="k">def</span> <span class="nf">ccf</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ref_exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cross Corrrelation Function or covariance calculation between two objects in flap storage. </span>
<span class="sd">    This is a wrapper for DataObject.ccf()</span>
<span class="sd">    If output name is set the CPSD object will be written back to the flap storage under this name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d_ref</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d_ref</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataObject</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid reference data structure. Should be string or flap.DataObject.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_ref</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ccf</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">d_ref</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="detrend"><a class="viewcode-back" href="../../data_object.html#flap.data_object.detrend">[docs]</a><span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; DETREND signal(s)</span>
<span class="sd">        INPUT:</span>
<span class="sd">            object_name: Name of the object in flap storage (string) </span>
<span class="sd">            exp_id: Experiment ID</span>
<span class="sd">            output_name: Name of the output object. If set result will be  stored under this name.</span>
<span class="sd">            coordinate: The coordinate for the detrend. If necessary data will be fitted with this coordinate</span>
<span class="sd">                        as x value.</span>
<span class="sd">            intervals: Information of processing intervals.</span>
<span class="sd">                       If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                           Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                           coordinate.</span>
<span class="sd">                           Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                           a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                           the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                           interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                           same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                           will be used fromm it to set the intervals.</span>
<span class="sd">                       If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                           description, the selection coordinate is taken the same as</span>
<span class="sd">                           coordinate.</span>
<span class="sd">                       If None, the whole data interval will be used as a single interval.</span>
<span class="sd">            options:</span>
<span class="sd">              &#39;Trend removal&#39;: Trend removal description (see also _trend_removal()). A list, string or None.</span>
<span class="sd">                None: Don&#39;t remove trend.</span>
<span class="sd">                Strings:</span>
<span class="sd">                  &#39;mean&#39;: subtract mean</span>
<span class="sd">                Lists:</span>
<span class="sd">                  [&#39;poly&#39;, n]: Fit an n order polynomial to the data and subtract.</span>
<span class="sd">                        Trend removal will be applied to each interval defined by slicing</span>
<span class="sd">                        separately.</span>
<span class="sd">        Return value:</span>
<span class="sd">            The resulting data object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="filter_data"><a class="viewcode-back" href="../../data_object.html#flap.data_object.filter_data">[docs]</a><span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 1D Data filter.</span>
<span class="sd">    INPUT:</span>
<span class="sd">        object_name: Name of the object in flap storage (string) </span>
<span class="sd">        exp_id: Experiment ID</span>
<span class="sd">        output_name: Name of the output object. If not set object_name will be used.</span>
<span class="sd">        coordinate: The x coordinate for the trend removal.</span>
<span class="sd">        intervals: Information of processing intervals.</span>
<span class="sd">                   If dictionary with a single key: {selection coordinate: description})</span>
<span class="sd">                       Key is a coordinate name which can be different from the calculation</span>
<span class="sd">                       coordinate.</span>
<span class="sd">                       Description can be flap.Intervals, flap.DataObject or</span>
<span class="sd">                       a list of two numbers. If it is a data object with data name identical to</span>
<span class="sd">                       the coordinate the error ranges of the data object will be used for</span>
<span class="sd">                       interval. If the data name is not the same as coordinate a coordinate with the</span>
<span class="sd">                       same name will be searched for in the data object and the value_ranges</span>
<span class="sd">                       will be used fromm it to set the intervals.</span>
<span class="sd">                   If not a dictionary and not None is is interpreted as the interval</span>
<span class="sd">                       description, the selection coordinate is taken the same as</span>
<span class="sd">                       coordinate.</span>
<span class="sd">                   If None, the whole data interval will be used as a single interval.</span>
<span class="sd">                options:</span>
<span class="sd">                    &#39;Type&#39; :</span>
<span class="sd">                        None: Do nothing.</span>
<span class="sd">                        &#39;Int&#39;: Single term IIF filter, like RC integrator. </span>
<span class="sd">                        &#39;Diff&#39;: Single term IIF filter, like RC differentiator.</span>
<span class="sd">                        &#39;Bandpass&#39;, &#39;Lowpass&#39;, &#39;Highpass&#39;: Filters designed by scipy.signal.iirdesign.</span>
<span class="sd">                                                           The filter type is in &#39;Design&#39;</span>
<span class="sd">                                   Bandpass: f_low - f_high</span>
<span class="sd">                                   Lowpass: - f_high</span>
<span class="sd">                                   Highpass: - f_low</span>
<span class="sd">                    &#39;Design&#39;: The design type of the bandpass, lowpass or highpass filter. </span>
<span class="sd">                              (&#39;Elliptic&#39;, &#39;Butterworth, &#39;Chebyshev I&#39;, &#39;Chebyshev II&#39;, &#39;Bessel&#39;) </span>
<span class="sd">                              The numpy.iirdesign function is used for generating the filter.  </span>
<span class="sd">                              Setting inconsistent parameters can cause strange results. E.g. too high attenuation</span>
<span class="sd">                              at too low frequency relative to the smapling frequency can be a problem.</span>
<span class="sd">                    &#39;f_low&#39;, &#39;f_high&#39;: Cut on/off frequencies. (Middle between passband and stopband edge.)</span>
<span class="sd">                    &#39;Steepness&#39;: Difference between passband and stopband edge frequencies as a fraction </span>
<span class="sd">                                 of the middle frequency.</span>
<span class="sd">                     &#39;Loss&#39;: The maximum loss in the passband in dB</span>
<span class="sd">                     &#39;Attenuation&#39;: The minimum attenuation in the stopband dB</span>
<span class="sd">                    &#39;Tau&#39;: time constant for integrator/differentiator (in units of the coordinate)</span>
<span class="sd">                    &#39;Power&#39;: Calculate square of the signal after filtering. (boolean)</span>
<span class="sd">                    &#39;Inttime&#39;: Integration time after power calculation. (in units of oordinate)    Return value: The data object with the filtered data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">filter_data</span><span class="p">(</span><span class="n">coordinate</span><span class="o">=</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">intervals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../data_object.html#flap.data_object.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>  <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">PICKLE_PROTOCOL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save one or more flap.DataObject-s using pickle.</span>
<span class="sd">    </span>
<span class="sd">    INPUT:</span>
<span class="sd">        data: If flap.DataObject than save this.</span>
<span class="sd">              If string or string list then find these data objects in flap storage and save them. </span>
<span class="sd">              Will also use exp_id to select data objects. These data objects can be restored</span>
<span class="sd">              into flap storage using load.</span>
<span class="sd">              If any other object save it.</span>
<span class="sd">        exp_id: Experiment ID to use in conjuction with data of it is a string.</span>
<span class="sd">        options: None at present</span>
<span class="sd">        protocol: The protocol to use</span>
<span class="sd">        filename: Name of the file to save to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Checking for string in data name.</span>
    <span class="c1"># If string or list of strings data will be taken from flap storage</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If working from flap storage</span>
        <span class="n">_data</span>
        <span class="c1"># Extending exp_id in case it is shorter than _data</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_exp_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_id</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_exp_id</span> <span class="o">=</span> <span class="n">exp_id</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_exp_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">_exp_id</span><span class="p">)):</span>
                    <span class="n">_exp_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_exp_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span><span class="n">_exp_id</span><span class="p">):</span>
            <span class="n">names_1</span><span class="p">,</span> <span class="n">exps_1</span> <span class="o">=</span> <span class="n">find_data_objects</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">e</span><span class="p">)</span> 
            <span class="n">names</span> <span class="o">+=</span> <span class="n">names_1</span>
            <span class="n">exps</span> <span class="o">+=</span> <span class="n">exps_1</span>
        <span class="n">save_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FLAP storage data&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">dn</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">exps</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">get_data_object</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">en</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>
            <span class="n">save_data</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">save_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FLAP any data&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot open file: &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span></div>

        
<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../data_object.html#flap.data_object.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data saved with flap.save()</span>
<span class="sd">    If the data in the file were written from the flap storage it will also be</span>
<span class="sd">    loaded there, unless  no_storage is set to True.</span>
<span class="sd">    </span>
<span class="sd">    INPUT:</span>
<span class="sd">        filename: Name of the file to read.</span>
<span class="sd">        options: &quot;No storage&quot;: (bool) If True don&#39;t store data in flap storage just return a list of them.</span>
<span class="sd">    Return value:</span>
<span class="sd">        If data was not written from flap storage the original object will be returned.</span>
<span class="sd">        If it was written out from flap storage a list of the read objects will be returned..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;No storage&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_options</span> <span class="o">=</span> <span class="n">flap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge_options</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                             <span class="n">section</span><span class="o">=</span><span class="s1">&#39;Save/Load&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_options</span><span class="p">[</span><span class="s1">&#39;No storage&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Option &#39;No storage&#39; should be boolean.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot open file: &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">save_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">save_data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; is not a flap save file.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAP any data&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">save_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">save_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAP storage data&#39;</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">del</span> <span class="n">save_data</span><span class="p">[</span><span class="s1">&#39;FLAP storage data&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">save_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_options</span><span class="p">[</span><span class="s1">&#39;No storage&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">flap</span><span class="o">.</span><span class="n">add_data_object</span><span class="p">(</span><span class="n">save_data</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; is not a flap save file.&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="abs_value"><a class="viewcode-back" href="../../data_object.html#flap.data_object.abs_value">[docs]</a><span class="k">def</span> <span class="nf">abs_value</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Absolute value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">abs_value</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d_out</span></div>

<div class="viewcode-block" id="phase"><a class="viewcode-back" href="../../data_object.html#flap.data_object.phase">[docs]</a><span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">phase</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d_out</span></div>

<div class="viewcode-block" id="real"><a class="viewcode-back" href="../../data_object.html#flap.data_object.real">[docs]</a><span class="k">def</span> <span class="nf">real</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Real value. (Does nothing for real data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">real</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d_out</span></div>

               
<div class="viewcode-block" id="imag"><a class="viewcode-back" href="../../data_object.html#flap.data_object.imag">[docs]</a><span class="k">def</span> <span class="nf">imag</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Real value. (Does nothing for real data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d_out</span></div>

<div class="viewcode-block" id="error_value"><a class="viewcode-back" href="../../data_object.html#flap.data_object.error_value">[docs]</a><span class="k">def</span> <span class="nf">error_value</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a data object with the error of self in it.</span>
<span class="sd">        options: &#39;High&#39;: Use high error if error is asymmetric</span>
<span class="sd">                 &#39;Low&#39;: Use low error is error is asymmetric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_data_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">error_value</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_data_object</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span><span class="n">output_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">d_out</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">FLAP</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../styleguide.html">FLAP Styleguide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sourcecode.html">FLAP source code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage of FLAP (tips/tricks/faq)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, S. Zoletnik et al..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>